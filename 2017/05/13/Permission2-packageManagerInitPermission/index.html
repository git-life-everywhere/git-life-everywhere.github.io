<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Permission第 2 篇 - PackageManager 对权限的初始化流程"><meta name="keywords" content="Permission权限管理"><meta name="author" content="Li Shuaiqi"><meta name="copyright" content="Li Shuaiqi"><title>Permission第 2 篇 - PackageManager 对权限的初始化流程 | Li Shuaiqi's Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 8.0.0"><link rel="alternate" href="/atom.xml" title="Li Shuaiqi's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E7%BB%BC%E8%BF%B0"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E5%85%B1%E4%BA%AB-uid"><span class="toc-text">1 添加共享 uid</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E8%A7%A3%E6%9E%90%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-text">2 解析系统配置信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E8%A7%A3%E6%9E%90-%E2%80%9Cgroup%E2%80%9D"><span class="toc-text">2.1 解析 “group”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E8%A7%A3%E6%9E%90-%E2%80%9Cpermission%E2%80%9D"><span class="toc-text">2.2 解析 “permission”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%A7%A3%E6%9E%90-%E2%80%9Cassign-permission%E2%80%9D"><span class="toc-text">2.3 解析 “assign-permission”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-text">2.4 数据同步</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B8%AD%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%9D%83%E9%99%90"><span class="toc-text">3 添加配置信息中的系统权限</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E8%AF%BB%E5%8F%96%E4%B8%8A%E4%B8%80%E6%AC%A1%E7%9A%84%E5%AE%89%E8%A3%85%E4%BF%A1%E6%81%AF"><span class="toc-text">4 读取上一次的安装信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%A7%A3%E6%9E%90-%E2%80%9Cpermissions%E2%80%9D-%E5%92%8C-%E2%80%9Cpermission-trees%E2%80%9D"><span class="toc-text">4.1 解析 “permissions” 和 “permission-trees”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%A7%A3%E6%9E%90-%E2%80%9Cpackage%E2%80%9D"><span class="toc-text">4.2 解析 “package”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-Settings-readPackageLPw"><span class="toc-text">4.2.1 Settings.readPackageLPw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E8%A7%A3%E6%9E%90-%E2%80%9Cperms%E2%80%9D-%E5%AD%90%E6%A0%87%E7%AD%BE-%E5%AE%89%E8%A3%85%E6%97%B6%E6%9D%83%E9%99%90"><span class="toc-text">4.2.1 解析 “perms” 子标签 - 安装时权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-1-Settings-readInstallPermissionsLPr"><span class="toc-text">4.2.1.1 Settings.readInstallPermissionsLPr</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-1-1-PermissionsS-grantInstallPermission"><span class="toc-text">4.2.1.1.1 PermissionsS.grantInstallPermission</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-1-2-PermissionsS-revokeInstallPermission"><span class="toc-text">4.2.1.1.2 PermissionsS.revokeInstallPermission</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-1-3-PermissionsS-updatePermissionFlags"><span class="toc-text">4.2.1.1.3 PermissionsS.updatePermissionFlags</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E8%A7%A3%E6%9E%90-%E2%80%9Cshared-user%E2%80%9D"><span class="toc-text">4.3 解析 “shared-user”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-Settings-readSharedUserLPw"><span class="toc-text">4.3.1 Settings.readSharedUserLPw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-Settings-addSharedUserLPw"><span class="toc-text">4.3.2 Settings.addSharedUserLPw</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%A1%AE%E5%AE%9A%E5%85%B1%E4%BA%AB-uid-%E6%9C%89%E6%95%88%E6%80%A7"><span class="toc-text">5 确定共享 uid 有效性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E8%AF%BB%E5%8F%96%E4%B8%8A%E4%B8%80%E6%AC%A1%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"><span class="toc-text">6 读取上一次运行时权限信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-RuntimePermissionsPersistence-readStateForUserSyncLPr"><span class="toc-text">6.1 RuntimePermissionsPersistence.readStateForUserSyncLPr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-RuntimePermissionsPersistence-parseRuntimePermissionsLPr"><span class="toc-text">6.2 RuntimePermissionsPersistence.parseRuntimePermissionsLPr</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%BA%94%E7%94%A8%E6%96%87%E4%BB%B6%E6%89%AB%E6%8F%8F"><span class="toc-text">7 应用文件扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E7%B3%BB%E7%BB%9F%E6%9D%83%E9%99%90%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-text">7.1 系统权限的定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E7%B3%BB%E7%BB%9F%E5%92%8C%E5%BA%94%E7%94%A8%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-text">7.2 系统和应用权限信息的解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-PMS-scanPackageDirtyLI"><span class="toc-text">7.3 PMS.scanPackageDirtyLI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E6%9B%B4%E6%96%B0%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"><span class="toc-text">8 更新权限信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-PMS-updatePermissionsLPw"><span class="toc-text">8.1 PMS.updatePermissionsLPw</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E6%8C%81%E4%B9%85%E5%8C%96%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-text">9 持久化权限相关信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-Settings-writeLPr"><span class="toc-text">9.1 Settings.writeLPr</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E9%BB%98%E8%AE%A4%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9D%83%E9%99%90%E6%8E%88%E4%BA%88"><span class="toc-text">10 默认运行时权限授予</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Li Shuaiqi</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，熬夜星人。”</div><div class="follow-button"><a href="https://lishuaiqi.top">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">91</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">23</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">30</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">one more thing</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://juejin.cn/post/7366896388658593803">小二哥的 Android 站</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Li Shuaiqi's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">Permission第 2 篇 - PackageManager 对权限的初始化流程</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Permission%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/">Permission权限管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">12.9k</span><span class="post-meta__separator">|</span><span>阅读时长: 61 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于  Android7.1.1 源码，分析权限管理机制</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>在分析 PackageManagerService 的时候，我们详细的分析了 PackageManagerService 的启动流程，包括安装信息解析，应用程序包的解析等等！</p>
<p>其中，涉及到了对系统中权限的解析和配置，但是由于 PackageManagerService 的启动流程过于负责，所以在 PackageManagerService 相关文章中，并没有对其进行启动的总结！</p>
<p>本系列文章我们详细的总结下权限相关的内容！</p>
<h1 id="1-添加共享-uid"><a href="#1-添加共享-uid" class="headerlink" title="1 添加共享 uid"></a>1 添加共享 uid</h1><p>在 PMS 启动的开始，创建了 Settings 对象，同时添加了一些系统定义的共享 uid！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mSettings = <span class="keyword">new</span> <span class="title class_">Settings</span>(mPackages);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.system&quot;</span>, Process.SYSTEM_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.phone&quot;</span>, RADIO_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.log&quot;</span>, LOG_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.nfc&quot;</span>, NFC_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.bluetooth&quot;</span>, BLUETOOTH_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.shell&quot;</span>, SHELL_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br></pre></td></tr></table></figure>
<p>addSharedUserLPw 方法会创建 SharedUserSetting 对象，保存到 Settings.mSharedUsers 中！</p>
<p>同时也会根据 uid 的取值添加到 Settings.mUserIds 或者 Settings.mOtherUserIds 中，取值判断的依据是：uid &gt;= Process.FIRST_APPLICATION_UID ()！</p>
<ul>
<li>如果是应用程序的 uid，会被添加到 mUserIds 中！</li>
<li>如果是系统服务/进程的 uid，会被添加到 mOtherUserIds 中！</li>
</ul>
<p>因为，这里添加的 5 种共享 uid 都是系统定义的，所以会添加到 Settings.mOtherUserIds 中！</p>
<h1 id="2-解析系统配置信息"><a href="#2-解析系统配置信息" class="headerlink" title="2 解析系统配置信息"></a>2 解析系统配置信息</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SystemConfig</span> <span class="variable">systemConfig</span> <span class="operator">=</span> SystemConfig.getInstance();</span><br><span class="line">mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br></pre></td></tr></table></figure>
<p>这个过程会解析以下目录中的文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/sysconfig：ALLOW_ALL</span><br><span class="line">/etc/permissions：ALLOW_ALL</span><br><span class="line">/odm/etc/sysconfig：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</span><br><span class="line">/odm/etc/permissions：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</span><br><span class="line">/oem/etc/sysconfig：ALLOW_FEATURES</span><br><span class="line">/oem/etc/permissions：ALLOW_FEATURES</span><br></pre></td></tr></table></figure>
<p>可以看到，和权限相关的目录是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/sysconfig：ALLOW_ALL</span><br><span class="line">/etc/permissions：ALLOW_ALL</span><br></pre></td></tr></table></figure>
<p>在解析过程中 etc/permissions/platform.xml 文件是被放到了最后处理！</p>
<p>在这个过程中会解析以下和权限相关的属性，我们来看下 platform.xml 文件中和权限相关的内容！</p>
<h2 id="2-1-解析-“group”"><a href="#2-1-解析-“group”" class="headerlink" title="2.1 解析 “group”"></a>2.1 解析 “group”</h2><p>获得系统中的一些特定的 gid，这些 gid 会和系统权限相互映射：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;permission name=<span class="string">&quot;android.permission.BLUETOOTH_STACK&quot;</span> &gt;</span><br><span class="line">    &lt;group gid=<span class="string">&quot;bluetooth&quot;</span> /&gt;</span><br><span class="line">    &lt;group gid=<span class="string">&quot;wakelock&quot;</span> /&gt;</span><br><span class="line">    &lt;group gid=<span class="string">&quot;uhid&quot;</span> /&gt;</span><br><span class="line">&lt;/permission&gt;</span><br></pre></td></tr></table></figure>
<p>group 标签不能单独使用，要和 permission 配合使用！</p>
<p>SystemConfig  会通过 android.os.Process.getGidForName 方法获得字符串 group 对应的 int 值！</p>
<p>getGidForName 是一个 native 方法，它的实际定义是 frameworks/base/core/jni/android_util_Process.cpp 中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">android_os_Process_getGidForName</span><span class="params">(JNIEnv* env, jobject clazz, jstring name)</span> </span>&#123;</span><br><span class="line">    ......    </span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> N = name<span class="number">8.</span><span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* str = name<span class="number">8.</span><span class="built_in">string</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str[i] &lt; <span class="string">&#x27;0&#x27;</span> || str[i] &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">group</span>* grp = <span class="built_in">getgrnam</span>(str);</span><br><span class="line">                <span class="keyword">if</span> (grp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;    </span><br><span class="line">                <span class="keyword">return</span> grp-&gt;gr_gid;</span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">atoi</span>(str);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里根据 groupName 调用 getgrnam 获取组信息。我们知道，getgrnam 是一个 C 库函数，在 Linux 中标准定义是根据读取 /etc/group 文件获取组信息，但在 Android 中并没有这个文件，那么这个函数是怎么实现的呢？</p>
<p>该函数是定义在 bionic/libc/bionic/stubs.cpp 文件中，这里我们只关注主要的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;private/android_filesystem_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> group* <span class="title">android_iinfo_to_group</span><span class="params">(group* gr, <span class="type">const</span> android_id_info* iinfo)</span> </span>&#123;</span><br><span class="line">  gr-&gt;gr_name   = (<span class="type">char</span>*) iinfo-&gt;name;</span><br><span class="line">  gr-&gt;gr_gid    = iinfo-&gt;aid;</span><br><span class="line">  gr-&gt;gr_mem[<span class="number">0</span>] = gr-&gt;gr_name;</span><br><span class="line">  gr-&gt;gr_mem[<span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> gr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> group* <span class="title">android_name_to_group</span><span class="params">(group* gr, <span class="type">const</span> <span class="type">char</span>* name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> n = <span class="number">0</span>; n &lt; android_id_count; ++n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(android_ids[n].name, name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">android_iinfo_to_group</span>(gr, android_ids + n);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">group* <span class="title">getgrnam</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name)</span> </span>&#123; <span class="comment">// NOLINT: implementing bad function.</span></span><br><span class="line">  <span class="type">stubs_state_t</span>* state = __stubs_state();</span><br><span class="line">  <span class="keyword">if</span> (state == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">android_name_to_group</span>(&amp;state-&gt;group_, name) != <span class="number">0</span>) &#123;                         </span><br><span class="line">    <span class="keyword">return</span> &amp;state-&gt;group_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">app_id_to_group</span>(<span class="built_in">app_id_from_name</span>(name), state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显而易见，它是遍历 android_ids 数组，查找是否有对应的组。那么 android_ids 定义在那里呢？</p>
<p>在 system\core\include\private\android_filesystem_config.h 文件中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">android_id_info</span> android_ids[] = &#123;</span><br><span class="line">    &#123; <span class="string">&quot;root&quot;</span>,          AID_ROOT, &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;system&quot;</span>,        AID_SYSTEM, &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;radio&quot;</span>,         AID_RADIO, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bluetooth&quot;</span>,     AID_BLUETOOTH, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;graphics&quot;</span>,      AID_GRAPHICS, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input&quot;</span>,         AID_INPUT, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;audio&quot;</span>,         AID_AUDIO, &#125;,</span><br><span class="line">    ... ... ...</span><br><span class="line">    &#123; <span class="string">&quot;everybody&quot;</span>,     AID_EVERYBODY, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;misc&quot;</span>,          AID_MISC, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;nobody&quot;</span>,        AID_NOBODY, &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到 android_ids 定义了 uid 的字符串名称和对应的 int 值的映射，AID_XXXX 用于指定其对应的 uid/gid：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#define AID_ROOT             <span class="number">0</span>  <span class="comment">/* traditional unix root user */</span></span><br><span class="line"></span><br><span class="line">#define AID_SYSTEM        <span class="number">1000</span>  <span class="comment">/* system server */</span></span><br><span class="line"></span><br><span class="line">#define AID_RADIO         <span class="number">1001</span>  <span class="comment">/* telephony subsystem, RIL */</span></span><br><span class="line">#define AID_BLUETOOTH     <span class="number">1002</span>  <span class="comment">/* bluetooth subsystem */</span></span><br><span class="line">#define AID_GRAPHICS      <span class="number">1003</span>  <span class="comment">/* graphics devices */</span></span><br><span class="line">#define AID_INPUT         <span class="number">1004</span>  <span class="comment">/* input devices */</span></span><br><span class="line">#define AID_AUDIO         <span class="number">1005</span>  <span class="comment">/* audio devices */</span></span><br><span class="line">... ... .. ...</span><br></pre></td></tr></table></figure>
<p>关于 android_filesystem_config.h 中的相关内容，我们后面再分析！</p>
<p>SystemConfig  会将解析到的这些全局特定的 gid 保存到 SystemConfig.mGlobalGids 中！</p>
<h2 id="2-2-解析-“permission”"><a href="#2-2-解析-“permission”" class="headerlink" title="2.2 解析 “permission”"></a>2.2 解析 “permission”</h2><p>获得系统权限和所属的 gid：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--解析 permission 标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bt_admin&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面是解析过程：</p>
<ul>
<li>创建一个 PermissionEntry 对象，用于封装解析到的权限信息！</li>
<li>解析 perUser 属性；</li>
<li>解析获得该权限映射的 gid，依然是调用了 Process.getGidForName 方法，保存到 PermissionEntry.gids 中！</li>
</ul>
<p>最后，将解析的数据会被保存到 Settings.mPermissions 中！</p>
<h2 id="2-3-解析-“assign-permission”"><a href="#2-3-解析-“assign-permission”" class="headerlink" title="2.3 解析 “assign-permission”"></a>2.3 解析 “assign-permission”</h2><p>给特定的 uid 分配指定的权限！ </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_SURFACE_FLINGER&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>assign-permission 标签用于给那些运行在特定的 uid 下的，没有对于 package 文件的系统进程赋予更高层次的权限，比如 MediaSever 守护进程！</p>
<p>下面是解析过程：</p>
<ul>
<li>调用 Process.getUidForName 获得字符串 uid 对应的 int 值，Process.getUidForName 方法最终还是调用的前面的 getgrnam 方法！</li>
</ul>
<p>最后，将解析的数据会被保存到 Settings.mSystemPermissions 中！</p>
<h2 id="2-4-数据同步"><a href="#2-4-数据同步" class="headerlink" title="2.4 数据同步"></a>2.4 数据同步</h2><p>SystemConfig  在解析完成后，会将 Settings.mSystemPermissions 和 SystemConfig.mGlobalGids 的数据同步保存到 PMS 的集合中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">mSystemPermissions = systemConfig.getSystemPermissions();</span><br></pre></td></tr></table></figure>
<h1 id="3-添加配置信息中的系统权限"><a href="#3-添加配置信息中的系统权限" class="headerlink" title="3 添加配置信息中的系统权限"></a>3 添加配置信息中的系统权限</h1><p>SystemConfig 在解析完了系统配置的权限和 gid 映射关系，同时我们也得到了一些系统的权限，这里会将这些权限添加到 mSettings.mPermissions 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">        = systemConfig.getPermissions();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i&lt; permConfig.size(); i++) &#123;</span><br><span class="line">    SystemConfig.<span class="type">PermissionEntry</span> <span class="variable">perm</span> <span class="operator">=</span> permConfig.valueAt(i);</span><br><span class="line">    <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> mSettings.mPermissions.get(perm.name);</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">null</span>) &#123;</span><br><span class="line">        bp = <span class="keyword">new</span> <span class="title class_">BasePermission</span>(perm.name, <span class="string">&quot;android&quot;</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">        <span class="comment">// 将这些系统权限添加到 Settings.mPermissions 中！</span></span><br><span class="line">        mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (perm.gids != <span class="literal">null</span>) &#123;</span><br><span class="line">        bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会创建 BasePermission 实例，指定权限定义者包名为 android，权限类型为 BasePermission.TYPE_BUILTIN！</p>
<p>如果该系统权限有映射特定的 gid，将其添加到 BasePermission.gids 中！</p>
<h1 id="4-读取上一次的安装信息"><a href="#4-读取上一次的安装信息" class="headerlink" title="4 读取上一次的安装信息"></a>4 读取上一次的安装信息</h1><p>接下来，Settings 会从 Packages.xml 中读取上一次安装的信息！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">sdkVersion</span>=<span class="string">&quot;27&quot;</span> <span class="attr">databaseVersion</span>=<span class="string">&quot;3&quot;</span> <span class="attr">fingerprint</span>=<span class="string">&quot;../release-keys&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">volumeUuid</span>=<span class="string">&quot;primary_physical&quot;</span> <span class="attr">sdkVersion</span>=<span class="string">&quot;27&quot;</span> <span class="attr">databaseVersion</span>=<span class="string">&quot;27&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">fingerprint</span>=<span class="string">&quot;.../release-keys&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission-trees</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REAL_GET_TASKS&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;18&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.android.providers.calendar&quot;</span> <span class="attr">codePath</span>=<span class="string">&quot;/system/priv-app/CalendarProvider&quot;</span> </span></span><br><span class="line"><span class="tag">                    <span class="attr">nativeLibraryPath</span>=<span class="string">&quot;/system/priv-app/CalendarProvider/lib&quot;</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">primaryCpuAbi</span>=<span class="string">&quot;armeabi-v7a&quot;</span> <span class="attr">publicFlags</span>=<span class="string">&quot;940064325&quot;</span> <span class="attr">privateFlags</span>=<span class="string">&quot;8&quot;</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">ft</span>=<span class="string">&quot;1624a4dcee0&quot;</span> <span class="attr">it</span>=<span class="string">&quot;1624a4dcee0&quot;</span> <span class="attr">ut</span>=<span class="string">&quot;1624a4dcee0&quot;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">version</span>=<span class="string">&quot;0&quot;</span> <span class="attr">sharedUserId</span>=<span class="string">&quot;10006&quot;</span> <span class="attr">isOrphaned</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">    ... ... ... ..</span><br><span class="line">    <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">&quot;android.uid.bluetooth&quot;</span> <span class="attr">userId</span>=<span class="string">&quot;1002&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REAL_GET_TASKS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">packages</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面这个 xml 文件显示了 packages.xml 中的文件结构，可以看到，他们会有一个解析的顺序！</p>
<p>这个过程会会解析获得很多数据，这里我们只关注和权限相关的数据！</p>
<h2 id="4-1-解析-“permissions”-和-“permission-trees”"><a href="#4-1-解析-“permissions”-和-“permission-trees”" class="headerlink" title="4.1 解析 “permissions” 和 “permission-trees”"></a>4.1 解析 “permissions” 和 “permission-trees”</h2><p>首先会解析 permission-trees 的内容，然后在解析 permissions 的内容，其保存了上一次安装时的系统和应用定义的所有的权限信息：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REAL_GET_TASKS&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;18&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SEND_RECEIVE_STK_INTENT&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.android.stk&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_CACHE_FILESYSTEM&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;18&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REMOTE_AUDIO_PLAYBACK&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.DOWNLOAD_WITHOUT_NOTIFICATION&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.android.providers.downloads&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REGISTER_WINDOW_MANAGER_LISTENERS&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>permissions 标签中保存的是非动态权限信息，permission-trees 中保存的是动态权限信息。</p>
<p>对于非动态权限和动态权限树，会有不同的处理：</p>
<ul>
<li><p>非动态权限信息最终都会被解析保存到 Setting.mPermissions 中了！！</p>
</li>
<li><p>动态权限信息会被保存在 Setting.mPermissionTrees 中了！！</p>
</li>
</ul>
<p><br></p>
<p>整个解析过程如下：</p>
<ul>
<li>解析获得权限名 name，权限的定义包名 package，权限类型 type，以及权限的保护级别 protection 并对其修正；<ul>
<li>修正就是为了保证附加标志位只能和基本权限类型 signiture 一起使用；  </li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>尝试从 Setttings 的权限集合中获得对应的权限对象 BasePermission <ul>
<li>如果为 null 就会创建新的 BasePermission 对象；</li>
<li>如果已有对应的 BasePermission 对象，但是其 type 不是 BasePermission.TYPE_BUILTIN，也会创建新的 BasePermission 对象 ！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>判断权限是不是动态权限：<ul>
<li>权限类型 type 是否是 dynamic，如果是，权限类型为 BasePermission.TYPE_DYNAMIC，不是就是 BasePermission.TYPE_NORMAL；</li>
<li>如果是非动态权限，就直接添加到 Setting.mPermissions 中；</li>
<li>如果是动态权限，会在创建一个 PermissionInfo 对象，封装所属权限树的信息，再添加到 Setting.mPermissionTrees 中；</li>
</ul>
</li>
</ul>
<h2 id="4-2-解析-“package”"><a href="#4-2-解析-“package”" class="headerlink" title="4.2 解析 “package”"></a>4.2 解析 “package”</h2><p>接着是解析 package 信息，主要是调用 readPackageLPw 方法！</p>
<h3 id="4-2-1-Settings-readPackageLPw"><a href="#4-2-1-Settings-readPackageLPw" class="headerlink" title="4.2.1 Settings.readPackageLPw"></a>4.2.1 Settings.readPackageLPw</h3><p>对于 readPackageLPw 方法，我们在 PMS 的启动流程中有详细分析，这里我们只关注和权限相关的代码！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readPackageLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException, IOException &#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】获得应用的 name！</span></span><br><span class="line">        name = parser.getAttributeValue(<span class="literal">null</span>, ATTR_NAME);</span><br><span class="line">        realName = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;realName&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】获得 userId 和 sharedId 的名称, userId 和 sharedIdStr 不能同时存在！</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;userId&quot;</span>);</span><br><span class="line">        uidError = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;uidError&quot;</span>);</span><br><span class="line">        sharedIdStr = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;sharedUserId&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        ... ... ...</span><br><span class="line">                    </span><br><span class="line">        <span class="comment">//【3】获得 userId 的 int 值，如果 AndroidManifest.xml 有设置 android:sharedUserId 属性，</span></span><br><span class="line">        <span class="comment">// 那么应用的 userId 就为 0！！</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> idStr != <span class="literal">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (resourcePathStr == <span class="literal">null</span>) &#123;</span><br><span class="line">            resourcePathStr = codePathStr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (realName != <span class="literal">null</span>) &#123;</span><br><span class="line">            realName = realName.intern();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">&quot;Error in package manager settings: &lt;package&gt; has no name at &quot;</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePathStr == <span class="literal">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">&quot;Error in package manager settings: &lt;package&gt; has no codePath at &quot;</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果 userId 大于0，说明 package 是独立用户 id</span></span><br><span class="line">            <span class="comment">// 调用 addPackageLPw 方法保存这个有独立的 Linux 用户 ID 的 Package!</span></span><br><span class="line">            packageSetting = addPackageLPw(name.intern(), realName, <span class="keyword">new</span> <span class="title class_">File</span>(codePathStr),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">File</span>(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiString,</span><br><span class="line">                    secondaryCpuAbiString, cpuAbiOverrideString, userId, versionCode, pkgFlags,</span><br><span class="line">                    pkgPrivateFlags, parentPackageName, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                Log.i(PackageManagerService.TAG, <span class="string">&quot;Reading package &quot;</span> + name + <span class="string">&quot;: userId=&quot;</span></span><br><span class="line">                        + userId + <span class="string">&quot; pkg=&quot;</span> + packageSetting);</span><br><span class="line">            <span class="keyword">if</span> (packageSetting == <span class="literal">null</span>) &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.ERROR, <span class="string">&quot;Failure adding uid &quot;</span></span><br><span class="line">                        + userId + <span class="string">&quot; while parsing settings at &quot;</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间</span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sharedIdStr != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.2】sharedIdStr 不为 null，说明 package 设置了共享用户 id！</span></span><br><span class="line">            userId = sharedIdStr != <span class="literal">null</span> ? Integer.parseInt(sharedIdStr) : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 对于共享用户 ID 这种情况，还需要验证其有效性!</span></span><br><span class="line">                <span class="comment">// 创建一个 PendingPackage 对象，来封装这个有共享用户 ID 的 package 的信息!</span></span><br><span class="line">                packageSetting = <span class="keyword">new</span> <span class="title class_">PendingPackage</span>(name.intern(), realName, <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">                        codePathStr), <span class="keyword">new</span> <span class="title class_">File</span>(resourcePathStr), legacyNativeLibraryPathStr,</span><br><span class="line">                        primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString,</span><br><span class="line">                        userId, versionCode, pkgFlags, pkgPrivateFlags, parentPackageName,</span><br><span class="line">                        <span class="literal">null</span>);</span><br><span class="line">                   </span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间！     </span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3.2.1】添加到 mPendingPackages 中，因为后续需要确定 shareUserId 的有效性！</span></span><br><span class="line">                mPendingPackages.add((PendingPackage) packageSetting);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                    Log.i(PackageManagerService.TAG, <span class="string">&quot;Reading package &quot;</span> + name</span><br><span class="line">                            + <span class="string">&quot;: sharedUserId=&quot;</span> + userId + <span class="string">&quot; pkg=&quot;</span> + packageSetting);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">&quot;Error in package manager settings: package &quot;</span> + name</span><br><span class="line">                                + <span class="string">&quot; has bad sharedId &quot;</span> + sharedIdStr + <span class="string">&quot; at &quot;</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">&quot;Error in package manager settings: package &quot;</span> + name + <span class="string">&quot; has bad userId &quot;</span></span><br><span class="line">                            + idStr + <span class="string">&quot; at &quot;</span> + parser.getPositionDescription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">&quot;Error in package manager settings: package &quot;</span> + name + <span class="string">&quot; has bad userId &quot;</span></span><br><span class="line">                        + idStr + <span class="string">&quot; at &quot;</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】接下解析和设置其他属性。</span></span><br><span class="line">    <span class="keyword">if</span> (packageSetting != <span class="literal">null</span>) &#123;</span><br><span class="line">        ... ... ...</span><br><span class="line">        <span class="type">int</span> <span class="variable">outerDepth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">        <span class="type">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">tagName</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">            <span class="comment">// Legacy</span></span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_DISABLED_COMPONENTS)) &#123;</span><br><span class="line">                readDisabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ENABLED_COMPONENTS)) &#123;</span><br><span class="line">                readEnabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;sigs&quot;</span>)) &#123; <span class="comment">// 解析 &quot;sigs&quot;</span></span><br><span class="line">                packageSetting.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSIONS)) &#123; </span><br><span class="line">                <span class="comment">//【4.2】解析 &quot;perms&quot; </span></span><br><span class="line">                readInstallPermissionsLPr(parser, packageSetting.getPermissionsState());</span><br><span class="line">                packageSetting.installPermissionsFixed = <span class="literal">true</span>;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;proper-signing-keyset&quot;</span>)) &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>流程总结：</p>
<ul>
<li>对于分配了独立的 uid 的 package，创建 PackageSetting 对象，添加到 mPackage 中，并且将自身和 uid 的引用关心保存到 mUsersId 或者 mOthersId 中；</li>
<li>对于分配了共享的 uid 的 package，创建 PendingPackage 对象，添加到 mPendingPackages 中，后续会对其共享 uid 的有效性进行校验！</li>
</ul>
<p>在解析过程中，会判断 package 是否是共享 uid 的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idStr = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;userId&quot;</span>);</span><br><span class="line">uidError = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;uidError&quot;</span>);</span><br><span class="line">sharedIdStr = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;sharedUserId&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>userId 和 sharedUserId 只能存在一个，如果 package 有 sharedUserId，那么 userId 会被设置为 0；</p>
<ul>
<li>如果 package 是独立 userId ，那么会立刻创建对应的 PackageSettings 对象！然后会调用 addPackageLPw 方法，将其添加到 Settings.mPackages 中！<ul>
<li>同时也会调用 addUserIdLPw 方法，将该 PackageSettings 添加到 Settings.mUserIds/Settings.mOtherUserIds 中，取决于 uid 的范围！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>如果 package 是共享 userId，这里会临时创建一个 PendingPackage 对象，添加到 Settings.mPendingPackages 中，因为共享 userId 的有效性没有确定！</li>
</ul>
<h3 id="4-2-1-解析-“perms”-子标签-安装时权限"><a href="#4-2-1-解析-“perms”-子标签-安装时权限" class="headerlink" title="4.2.1 解析 “perms” 子标签 - 安装时权限"></a>4.2.1 解析 “perms” 子标签 - 安装时权限</h3><p>对于上一次安装信息，package 的 perms 子标签保存了该 package 申请的安装时权限，注意是<strong>安装时权限</strong>！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REAL_GET_TASKS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行时权限在另外的地方保存，我们后面再看！</p>
<p>接着是解析 package 的安装时权限信息，主要是调用 readInstallPermissionsLPr 方法！</p>
<h4 id="4-2-1-1-Settings-readInstallPermissionsLPr"><a href="#4-2-1-1-Settings-readInstallPermissionsLPr" class="headerlink" title="4.2.1.1 Settings.readInstallPermissionsLPr"></a>4.2.1.1 Settings.readInstallPermissionsLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">readInstallPermissionsLPr</span><span class="params">(XmlPullParser parser, PermissionsState permissionsState)</span> </span><br><span class="line">                                                    <span class="keyword">throws</span> IOException, XmlPullParserException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">outerDepth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">    <span class="type">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">            || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tagName</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 &quot;item&quot;</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_NAME); <span class="comment">// 接续 &quot;name&quot;，权限名称！</span></span><br><span class="line">            <span class="comment">//【1】从之前解析的 Settings.mPermissions 获得对应的权限，如果没有，就跳过；</span></span><br><span class="line">            <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> mPermissions.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="literal">null</span>) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">&quot;Unknown permission: &quot;</span> + name);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】解析 &quot;granted&quot; 标签，获得授予情况！</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">grantedStr</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_GRANTED);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">granted</span> <span class="operator">=</span> grantedStr == <span class="literal">null</span></span><br><span class="line">                    || Boolean.parseBoolean(grantedStr);</span><br><span class="line">            <span class="comment">// 解析 &quot;flags&quot;标签</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">flagsStr</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_FLAGS);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> (flagsStr != <span class="literal">null</span>)</span><br><span class="line">                    ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】处理权限授予的操作！</span></span><br><span class="line">            <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">                <span class="comment">//【9.1】处理默认授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">&quot;Permission already added: &quot;</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">//【9.2】处理默认不授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">&quot;Permission already added: &quot;</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【9.3】更新应用权限信息！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">&quot;Unknown element under &lt;permissions&gt;: &quot;</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里解析到的权限授予信息会保存到 PermissionsState 对象中！</p>
<ul>
<li>首先会判断 Settings.mPermissions 中是否有对应的权限，如果没有，就会忽略掉该安装时权限的授予！</li>
<li>解析授予状态 granted，值为 true，因为是安装时权限，解析权限的授予标志位信息 flags；</li>
<li>接着处理安装时权限的授予情况！</li>
</ul>
<p></p>
<p>PermissionsState permissionsState 用于保存该 package 的权限状态信息，通过 packageSetting.getPermissionsState() 方法获得，如果应用是独立的 uid，那么该方法返回的是自身的 PermissionsState，如果是共享 uid，返回的是 ShareUserId 的 PermissionsState！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PermissionsState <span class="title function_">getPermissionsState</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (sharedUser != <span class="literal">null</span>)</span><br><span class="line">            ? sharedUser.getPermissionsState()</span><br><span class="line">            : <span class="built_in">super</span>.getPermissionsState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PermissionsState 内部有一个 mPermissions 哈希表，key 为权限 name，value 为 PermissionData，PermissionData 用于保存权限的授予情况；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArrayMap&lt;String, PermissionData&gt; mPermissions;</span><br></pre></td></tr></table></figure>
<p>接着是处理安装时权限的授予情况：</p>
<h5 id="4-2-1-1-1-PermissionsS-grantInstallPermission"><a href="#4-2-1-1-1-PermissionsS-grantInstallPermission" class="headerlink" title="4.2.1.1.1 PermissionsS.grantInstallPermission"></a>4.2.1.1.1 PermissionsS.grantInstallPermission</h5><p>permissionsState.grantInstallPermission 方法用于授予安装时权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">grantPermission</span><span class="params">(BasePermission permission, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="comment">//【9.1.1】如果之前有权限，本次授予失败！</span></span><br><span class="line">    <span class="keyword">if</span> (hasPermission(permission.name, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【9.1.2】判断权限 BasePermission 在 userId 下是否有映射 gid，如果有，那 hasGids 为 true！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">hasGids</span> <span class="operator">=</span> !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line">    <span class="comment">//【9.1.3】如果权限 BasePermission 有映射的 gid，那就计算下该 package 的所属的 Gid 组！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line">    <span class="comment">//【9.1.4】创建权限的 permissionData 对象，并添加到 PermissionState.mPermissions 中！</span></span><br><span class="line">    <span class="type">PermissionData</span> <span class="variable">permissionData</span> <span class="operator">=</span> ensurePermissionData(permission);</span><br><span class="line">    <span class="comment">//【9.1.5】授予权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionData.grant(userId)) &#123; <span class="comment">// 授权失败，就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果权限有映射的 gid，在授予权限后，再次计算该 package 的所有映射的 gid！</span></span><br><span class="line">    <span class="comment">// 比较授权前后，gid 组是否发生了变化，如果有，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED！</span></span><br><span class="line">    <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span>[] newGids = computeGids(userId);</span><br><span class="line">        <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS; <span class="comment">// 返回 PERMISSION_OPERATION_SUCCESS！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为是安装时权限，所以传入的 userId 为 UserHandle.USER_ALL！</p>
<p>hasPermission 方法用于判断该权限是否已经授予权限，如果已经授予，那就返回 <strong>PERMISSION_OPERATION_FAILURE</strong>！</p>
<p>hasGids 用于判断当前要处理的安装时权限是否有映射的 gid，如果有那个 hasGids 为 true！</p>
<p>如果 hasGids 为 true，那就要计算下该 package 当前所持有的所有权限的映射的 gid 组！</p>
<p>接着，创建权限的 permissionData 对象，并添加到 PermissionState.mPermissions 中，key 为权限名！</p>
<p>permissionData.grant 方法用于设置权限为授予状态：</p>
<p>PermissionData 内部有一个 SparseArray，保存了该权限在不用 userId 下的授予状态，可以知道，对于安装时权限，由于 userid 为 UserHandle.USER_ALL，所以 mUserStates 只有一条数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SparseArray&lt;PermissionState&gt; mUserStates = <span class="keyword">new</span> <span class="title class_">SparseArray</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>如果授予失败，比如该权限已经授予等等，那么会返回 <strong>PERMISSION_OPERATION_FAILURE</strong>！！</p>
<p>如果 hasGids 为 true，那么在授予后，再次计算该 package 当前持有的权限映射的所有 gid，如果 gid 发生了变化，那么返回 <strong>PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED</strong>！</p>
<p>如果 gid 没有发生变化，那么返回 <strong>PERMISSION_OPERATION_SUCCESS</strong>，那么会有发生变化的情况吗？是有的，比如应用程序定义的权限是没有映射 gid 的！</p>
<p>如果返回的是 PERMISSION_OPERATION_SUCCESS 或者 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED ，那么接下来就会保存标志位信息！</p>
<h5 id="4-2-1-1-2-PermissionsS-revokeInstallPermission"><a href="#4-2-1-1-2-PermissionsS-revokeInstallPermission" class="headerlink" title="4.2.1.1.2 PermissionsS.revokeInstallPermission"></a>4.2.1.1.2 PermissionsS.revokeInstallPermission</h5><p>permissionsState.revokeInstallPermission 方法用于安装时撤销权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">revokePermission</span><span class="params">(BasePermission permission, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="comment">//【1】如果没有授予该权限，那就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">    <span class="keyword">if</span> (!hasPermission(permission.name, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】同样，计算该权限是否有映射 gid，如果有 gid，计算当前 package 持有的权限映射的所有 gid！</span></span><br><span class="line">    <span class="comment">// 保存到 oldGids 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">hasGids</span> <span class="operator">=</span> !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line"></span><br><span class="line">    <span class="type">PermissionData</span> <span class="variable">permissionData</span> <span class="operator">=</span> mPermissions.get(permission.name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.1】取消权限的授予！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionData.revoke(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.2】如果该权限在所有设备用户下均没有授予该 package，即 mUserStates.size() &lt;= 0；</span></span><br><span class="line">    <span class="comment">// 那么我们要移除该权限！</span></span><br><span class="line">    <span class="keyword">if</span> (permissionData.isDefault()) &#123;</span><br><span class="line">        ensureNoPermissionData(permission.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】这里是比较，在撤销安装时权限后，该 package 所持有的权限映射的 gid 是否发生变化！</span></span><br><span class="line">    <span class="comment">// 如果有，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED！</span></span><br><span class="line">    <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span>[] newGids = computeGids(userId);</span><br><span class="line">        <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个过程和授予很类似，这里不多说！</p>
<h5 id="4-2-1-1-3-PermissionsS-updatePermissionFlags"><a href="#4-2-1-1-3-PermissionsS-updatePermissionFlags" class="headerlink" title="4.2.1.1.3 PermissionsS.updatePermissionFlags"></a>4.2.1.1.3 PermissionsS.updatePermissionFlags</h5><p>如果返回的是 PERMISSION_OPERATION_SUCCESS 或者 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED ，那么接下来就会保存标志位信息！</p>
<p>参数传递：</p>
<ul>
<li>userId 传入的是 UserHandle.USER_ALL；</li>
<li>flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，取值为 0xFF，转为二进制就是 11111</li>
<li>flagValues 则是解析上次安装信息时，解析该 package 的 perms 标签时，每一个权限的 flags！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updatePermissionFlags</span><span class="params">(BasePermission permission, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> flagMask, <span class="type">int</span> flagValues)</span> &#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">mayChangeFlags</span> <span class="operator">=</span> flagValues != <span class="number">0</span> || flagMask != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 mPermissions 为 null，且需要更新 flags，那么会初始化 mPermissions，将 permission 添加进入！</span></span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果该权限 permission 没有对应的 PermissionData，且需要更新 flags，那么我们会创建 PermissionData 添加！</span></span><br><span class="line">    <span class="type">PermissionData</span> <span class="variable">permissionData</span> <span class="operator">=</span> mPermissions.get(permission.name);</span><br><span class="line">    <span class="keyword">if</span> (permissionData == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        permissionData = ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】获得该权限的旧的 flags，用于对比！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">oldFlags</span> <span class="operator">=</span> permissionData.getFlags(userId);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【9.3.1】更新权限标志位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">updated</span> <span class="operator">=</span> permissionData.updateFlags(userId, flagMask, flagValues);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果权限的状态发生了变化，那就判断是否需要重新申请！</span></span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newFlags</span> <span class="operator">=</span> permissionData.getFlags(userId);</span><br><span class="line">        <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired == <span class="literal">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired = <span class="keyword">new</span> <span class="title class_">SparseBooleanArray</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.1】如果在该 userId 下需要重新申请，那么就将其添加到 mPermissionReviewRequired 中！</span></span><br><span class="line">            mPermissionReviewRequired.put(userId, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.2】如果在该 userId 下不需要重新申请，那么就将其从 mPermissionReviewRequired 中移除！</span></span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired != <span class="literal">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired.delete(userId);</span><br><span class="line">                <span class="keyword">if</span> (mPermissionReviewRequired.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPermissionReviewRequired = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updated;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 mayChangeFlags，由于我们 flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，那就意味了需要更新 flags！</p>
<p>可以看到，如果 mayChangeFlags 为 true 的话，即使没有权限对应的 PermissionData 也会创建，因为这次会更新 flags！</p>
<p>PermissionData.getFlags 方法会获得权限旧的 flags！</p>
<p>重点的操作在 PermissionData.updateFlag 方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateFlags</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> flagMask, <span class="type">int</span> flagValues)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isInstallPermission()) &#123;</span><br><span class="line">        <span class="comment">// 如果是安装时权限，那么 userId 为 UserHandle.USER_ALL;</span></span><br><span class="line">        userId = UserHandle.USER_ALL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123;</span><br><span class="line">        <span class="comment">// 如果 userId 不兼容，那么会直接返回！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】这里进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newFlags</span> <span class="operator">=</span> flagValues &amp; flagMask;</span><br><span class="line">    <span class="comment">//【2】获得该 userId 下的权限状态值！</span></span><br><span class="line">    <span class="type">PermissionState</span> <span class="variable">userState</span> <span class="operator">=</span> mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">oldFlags</span> <span class="operator">=</span> userState.mFlags;</span><br><span class="line">        <span class="comment">//【2.1】取消旧的 flags，设置新的 flags！</span></span><br><span class="line">        userState.mFlags = (userState.mFlags &amp; ~flagMask) | newFlags;</span><br><span class="line">        <span class="keyword">if</span> (userState.isDefault()) &#123;</span><br><span class="line">            mUserStates.remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.2】判断 flags 是否发生变化，如果发生了变化，那就返回 true！</span></span><br><span class="line">        <span class="keyword">return</span> userState.mFlags != oldFlags;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newFlags != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.3】如果该权限在该 userId 下没有状态信息，那就创建状态信息，直接设置新的 flags，返回 true！</span></span><br><span class="line">        userState = <span class="keyword">new</span> <span class="title class_">PermissionState</span>(mPerm.name);</span><br><span class="line">        userState.mFlags = newFlags;</span><br><span class="line">        mUserStates.put(userId, userState);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个操作：</p>
<ul>
<li>首先，进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位，为 newFlags；</li>
<li>接着，userState.mFlags 表示旧的 flags，这里在 userState.mFlags 和 ~flagMask 中做了 &amp; 操作，等价于取了 userState.mFlags 和 flagMask 不同的位，然后加上 newFlags，作为新的 flags！</li>
</ul>
<p>结合前面的参数：</p>
<p>flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS 每一个位都是 1，userState.mFlags &amp; ~flagMask 操作清空了旧的 flags；flagValues &amp; flagMask 计算得到的标志位 newFlags 就是 flagValues！</p>
<p>其实本质上就是设置标志位为 xml 中解析的值！</p>
<h2 id="4-3-解析-“shared-user”"><a href="#4-3-解析-“shared-user”" class="headerlink" title="4.3 解析 “shared-user”"></a>4.3 解析 “shared-user”</h2><p>共享用户相关数据如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">&quot;android.media&quot;</span> <span class="attr">userId</span>=<span class="string">&quot;10014&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_MEDIA_STORAGE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        ... ... </span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接下来是解析共享 uid，以及共享 uid 被授予的安装时权限！</p>
<h3 id="4-3-1-Settings-readSharedUserLPw"><a href="#4-3-1-Settings-readSharedUserLPw" class="headerlink" title="4.3.1 Settings.readSharedUserLPw"></a>4.3.1 Settings.readSharedUserLPw</h3><p>解析系统定义的共享用户 id：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readSharedUserLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pkgFlags</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pkgPrivateFlags</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">SharedUserSetting</span> <span class="variable">su</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        name = parser.getAttributeValue(<span class="literal">null</span>, ATTR_NAME); <span class="comment">// 获得共享用户的名称</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;userId&quot;</span>); <span class="comment">// 获得共享用户的id</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> idStr != <span class="literal">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;system&quot;</span>))) &#123; <span class="comment">// 是否是系统的用户 id！</span></span><br><span class="line">            pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId == <span class="number">0</span>) &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4.3.2】调用 addSharedUserLPw 方法，将这个共享用户和对应的 uid 保存下来！</span></span><br><span class="line">            <span class="keyword">if</span> ((su = addSharedUserLPw(name.intern(), userId, pkgFlags, pkgPrivateFlags))</span><br><span class="line">                    == <span class="literal">null</span>) &#123;</span><br><span class="line">                PackageManagerService</span><br><span class="line">                        .reportSettingsProblem(Log.ERROR, <span class="string">&quot;Occurred while parsing settings at &quot;</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">&quot;Error in package manager settings: package &quot;</span> + name + <span class="string">&quot; has bad userId &quot;</span></span><br><span class="line">                        + idStr + <span class="string">&quot; at &quot;</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (su != <span class="literal">null</span>) &#123; <span class="comment">// 解析子标签！</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">outerDepth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">        <span class="type">int</span> type;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">tagName</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;sigs&quot;</span>)) &#123;</span><br><span class="line">                su.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">&quot;perms&quot;</span>)) &#123; <span class="comment">// 解析 &quot;perms&quot; 标签</span></span><br><span class="line">                <span class="comment">//【4.3.3】解析共享用户的权限信息！</span></span><br><span class="line">                readInstallPermissionsLPr(parser, su.getPermissionsState());</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">&quot;Unknown element under &lt;shared-user&gt;: &quot;</span> + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>可以看到，整个过程和解析 package 类似！</p>
<p>addSharedUserLPw 会创建对应的 SharedUserSetting 对象，在解析共享 uid 的安装时权限时，会通过 SharedUserSetting.getPermissionsState() 获得权限管理状态对象！</p>
<h3 id="4-3-2-Settings-addSharedUserLPw"><a href="#4-3-2-Settings-addSharedUserLPw" class="headerlink" title="4.3.2 Settings.addSharedUserLPw"></a>4.3.2 Settings.addSharedUserLPw</h3><p>addSharedUserLPw 会创建对应的 SharedUserSetting 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SharedUserSetting <span class="title function_">addSharedUserLPw</span><span class="params">(String name, <span class="type">int</span> uid, <span class="type">int</span> pkgFlags, <span class="type">int</span> pkgPrivateFlags)</span> &#123;</span><br><span class="line">    <span class="comment">//【1】创建共享用户对应的 SharedUserSetting 对象！</span></span><br><span class="line">    <span class="type">SharedUserSetting</span> <span class="variable">s</span> <span class="operator">=</span> mSharedUsers.get(name);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">&quot;Adding duplicate shared user, keeping first: &quot;</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s = <span class="keyword">new</span> <span class="title class_">SharedUserSetting</span>(name, pkgFlags, pkgPrivateFlags);</span><br><span class="line">    s.userId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【8.1.1.2.1】根据 uid 的范围，保存到 mUsersId 和 mOthersId 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</span><br><span class="line">        <span class="comment">// 将其添加到 mSharedUsers 集合中！</span></span><br><span class="line">        mSharedUsers.put(name, s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>流程总结：</p>
<ul>
<li>解析 “shared-user” ，将其分装成 SharedUserSetting 对象，保存到 Settings.mSharedUsers，并根据 uid 的取值将其保存到 mUserIds 或者 mOtherIds 中！</li>
<li>解析 “shared-user” 子标签 “perm” 等等，解析共享用户的权限，每个权限对应一个 PermissionData 对象，保存进入 PermisssionState 中，用于管理共享用户的权限！</li>
</ul>
<h1 id="5-确定共享-uid-有效性"><a href="#5-确定共享-uid-有效性" class="headerlink" title="5 确定共享 uid 有效性"></a>5 确定共享 uid 有效性</h1><p>主要逻辑如下，我们知道 mPendingPackages 中包含了 uid 为共享 uid 的 PackageSettings<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】对 mPendingPackages 集合中的需要验证共享用户 id 有效性的 package，进行共享用户 id 有效性的验证!</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> mPendingPackages.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">PendingPackage</span> <span class="variable">pp</span> <span class="operator">=</span> mPendingPackages.get(i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.2.1】看 sharedId 是否能对应找到一个 ShardUserSetting 对象!</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">idObj</span> <span class="operator">=</span> getUserIdLPr(pp.sharedId);</span><br><span class="line">    <span class="keyword">if</span> (idObj != <span class="literal">null</span> &amp;&amp; idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123; <span class="comment">// 能找到，说明共享用户 ID 是有效的!</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【8.2.2】创建 PackageSetting！</span></span><br><span class="line">        <span class="type">PackageSetting</span> <span class="variable">p</span> <span class="operator">=</span> getPackageLPw(pp.name, <span class="literal">null</span>, pp.realName,</span><br><span class="line">                (SharedUserSetting) idObj, pp.codePath, pp.resourcePath,</span><br><span class="line">                pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString,</span><br><span class="line">                pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags,</span><br><span class="line">                <span class="literal">null</span>, <span class="literal">true</span> <span class="comment">/* add */</span>, <span class="literal">false</span> <span class="comment">/* allowInstall */</span>, pp.parentPackageName,</span><br><span class="line">                pp.childPackageNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">&quot;Unable to create application package for &quot;</span> + pp.name);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 PendingPackage 的其他数据拷贝到 PackageSetting 中！</span></span><br><span class="line">        p.copyFrom(pp); </span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idObj != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Bad package setting: package &quot;</span> + pp.name + <span class="string">&quot; has shared uid &quot;</span></span><br><span class="line">                + pp.sharedId + <span class="string">&quot; that is not a shared uid\n&quot;</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Bad package setting: package &quot;</span> + pp.name + <span class="string">&quot; has shared uid &quot;</span></span><br><span class="line">                + pp.sharedId + <span class="string">&quot; that is not defined\n&quot;</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mPendingPackages.clear(); <span class="comment">// 清空 mPendingPackages</span></span><br></pre></td></tr></table></figure><br>过程很简单，就是从前面解析得到的 Settings.mSharedUsers 中尝试获得 package 的共享 uid 对应的 SharedUserSetting 对象，如果存在，那么就说明共享 uid 是有效的！</p>
<p>getPackageLPw 方法会为那些在 mPendingPackages 中的 PendingPackage 创建对应的 PackageSetting，同时设置他们的共享 uid 为 SharedUserSetting，然后会将其添加到 Settings.mPackages 中！</p>
<p>这里调用 getUserIdLPr 来从 mUserIds 或 mOtherUserIds 中获得一个共享用户对象 SharedUserSetting！</p>
<h1 id="6-读取上一次运行时权限信息"><a href="#6-读取上一次运行时权限信息" class="headerlink" title="6 读取上一次运行时权限信息"></a>6 读取上一次运行时权限信息</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【8.4】读取每个 user 下的运行时权限信息！</span></span><br><span class="line"><span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">    mRuntimePermissionsPersistence.readStateForUserSyncLPr(user.id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是读取运行时权限的信息！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">runtime-permissions</span> <span class="attr">fingerprint</span>=<span class="string">&quot;OPPO/R11s/R11s:8.1.0/OPM1.171019.011/1519198279:user/release-keys&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pkg</span> <span class="attr">name</span>=<span class="string">&quot;com.sohu.inputmethod.sogouoem&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">pkg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">&quot;android.uid.calendar&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_CALENDAR&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">runtime-permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="6-1-RuntimePermissionsPersistence-readStateForUserSyncLPr"><a href="#6-1-RuntimePermissionsPersistence-readStateForUserSyncLPr" class="headerlink" title="6.1 RuntimePermissionsPersistence.readStateForUserSyncLPr"></a>6.1 RuntimePermissionsPersistence.readStateForUserSyncLPr</h2><p>该方法会读取指定的 userId 下的运行时权限信息，因为运行时权限每个设备用户下都不一样！</p>
<p>运行时权限记录在 /data/system/users/0/runtime-permissions.xml 文件中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readStateForUserSyncLPr</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="comment">//【1】获得运行时权限文件对象 runtime-permissions.xml！</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">permissionsFile</span> <span class="operator">=</span> getUserRuntimePermissionsFile(userId);</span><br><span class="line">    <span class="keyword">if</span> (!permissionsFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileInputStream in;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> <span class="title class_">AtomicFile</span>(permissionsFile).openRead();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</span><br><span class="line">        Slog.i(PackageManagerService.TAG, <span class="string">&quot;No permissions state&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">XmlPullParser</span> <span class="variable">parser</span> <span class="operator">=</span> Xml.newPullParser();</span><br><span class="line">        parser.setInput(in, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//【6.2】解析运行时权限数据！</span></span><br><span class="line">        parseRuntimePermissionsLPr(parser, userId);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed parsing permissions file: &quot;</span></span><br><span class="line">                + permissionsFile , e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析过程在 parseRuntimePermissionsLPr 方法中！</p>
<h2 id="6-2-RuntimePermissionsPersistence-parseRuntimePermissionsLPr"><a href="#6-2-RuntimePermissionsPersistence-parseRuntimePermissionsLPr" class="headerlink" title="6.2 RuntimePermissionsPersistence.parseRuntimePermissionsLPr"></a>6.2 RuntimePermissionsPersistence.parseRuntimePermissionsLPr</h2><p>用于解析运行时权限文件，获得上一次安装时的运行时权限相关的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseRuntimePermissionsLPr</span><span class="params">(XmlPullParser parser, <span class="type">int</span> userId)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, XmlPullParserException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">outerDepth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">    <span class="type">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> TAG_RUNTIME_PERMISSIONS: &#123; <span class="comment">//【1】解析 runtime-permissions 标签</span></span><br><span class="line">                <span class="comment">// 解析 fingerprint 属性，保存到 mFingerprints 中！</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">fingerprint</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_FINGERPRINT); </span><br><span class="line">                mFingerprints.put(userId, fingerprint); </span><br><span class="line"></span><br><span class="line">                <span class="comment">// 然用用本次启动系统的 fingerprint 判断系统是否有升级，如果没有升级 defaultsGranted 为 true！</span></span><br><span class="line">                <span class="comment">// 后面默认授予运行时权限会用到！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">defaultsGranted</span> <span class="operator">=</span> Build.FINGERPRINT.equals(fingerprint);</span><br><span class="line">                mDefaultPermissionsGranted.put(userId, defaultsGranted);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_PACKAGE: &#123;  <span class="comment">//【2】解析 pkg 标签</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_NAME);</span><br><span class="line">                <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps == <span class="literal">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">&quot;Unknown package:&quot;</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【6.2.1】解析并处理 package 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, ps.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_SHARED_USER: &#123;  <span class="comment">//【3】解析 shared-user 标签</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_NAME);</span><br><span class="line">                <span class="type">SharedUserSetting</span> <span class="variable">sus</span> <span class="operator">=</span> mSharedUsers.get(name);</span><br><span class="line">                <span class="keyword">if</span> (sus == <span class="literal">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">&quot;Unknown shared user:&quot;</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【6.2.1】解析并处理 shared-user 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, sus.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_RESTORED_RUNTIME_PERMISSIONS: &#123; <span class="comment">// restored-perms 标签</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">pkgName</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_PACKAGE_NAME);</span><br><span class="line">                parseRestoredRuntimePermissionsLPr(parser, pkgName, userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mDefaultPermissionsGranted 用于判断是否进行默认运行时权限授予的！</p>
<h1 id="7-应用文件扫描"><a href="#7-应用文件扫描" class="headerlink" title="7 应用文件扫描"></a>7 应用文件扫描</h1><p>PMS 会按照顺序扫描以下目录：</p>
<ul>
<li><strong>/vendor/overlay</strong></li>
<li><strong>/system/framework</strong></li>
<li><strong>/system/priv-app</strong></li>
<li><strong>/system/app</strong></li>
<li><strong>/vendor/app</strong></li>
<li><strong>/oem/app</strong></li>
</ul>
<p>调用 PMS.scanDirTracedLI 进行扫描，需要注意的是被扫描目录的顺序，这个顺序意味着：先被扫描到的文件，就是最终被用到的文件。</p>
<h2 id="7-1-系统权限的定义"><a href="#7-1-系统权限的定义" class="headerlink" title="7.1 系统权限的定义"></a>7.1 系统权限的定义</h2><p>系统的权限定义在 \android\frameworks\base\core\res\AndroidManifest.xml 文件中！但实际上最终会通过编译生成 framework-res.apk！</p>
<p>我们来看看具体的权限定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;permission-group android:name=<span class="string">&quot;android.permission-group.CONTACTS&quot;</span></span><br><span class="line">     android:icon=<span class="string">&quot;@drawable/perm_group_contacts&quot;</span></span><br><span class="line">     android:label=<span class="string">&quot;@string/permgrouplab_contacts&quot;</span></span><br><span class="line">     android:description=<span class="string">&quot;@string/permgroupdesc_contacts&quot;</span></span><br><span class="line">     android:priority=<span class="string">&quot;100&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line"> &lt;!-- Allows an application to read the user<span class="string">&#x27;s contacts data.</span></span><br><span class="line"><span class="string">     &lt;p&gt;Protection level: dangerous</span></span><br><span class="line"><span class="string"> --&gt;</span></span><br><span class="line"><span class="string"> &lt;permission android:name=&quot;android.permission.READ_CONTACTS&quot;</span></span><br><span class="line"><span class="string">     android:permissionGroup=&quot;android.permission-group.CONTACTS&quot;</span></span><br><span class="line"><span class="string">     android:label=&quot;@string/permlab_readContacts&quot;</span></span><br><span class="line"><span class="string">     android:description=&quot;@string/permdesc_readContacts&quot;</span></span><br><span class="line"><span class="string">     android:protectionLevel=&quot;dangerous&quot; /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="7-2-系统和应用权限信息的解析"><a href="#7-2-系统和应用权限信息的解析" class="headerlink" title="7.2 系统和应用权限信息的解析"></a>7.2 系统和应用权限信息的解析</h2><p>解析系统权限的过程，其实就是解析 framework-res.apk 的过程！</p>
<p>对于这一部分，可以看【应用程序的权限配置和解析】这边博文！</p>
<p>在解析完 Apk 的 AndroidManifest.xml 中定义和申请的权限信息后，会进入扫描的最后阶段 PMS.scanPackageDirtyLI</p>
<h2 id="7-3-PMS-scanPackageDirtyLI"><a href="#7-3-PMS-scanPackageDirtyLI" class="headerlink" title="7.3 PMS.scanPackageDirtyLI"></a>7.3 PMS.scanPackageDirtyLI</h2><p>无论是系统应用，还是三方应用，最终都会调用 scanPackageDirtyLI 方法处理扫描得到的数据：</p>
<p>这里我们重点看和权限相关的代码段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.Package <span class="title function_">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> policyFlags, <span class="keyword">final</span> <span class="type">int</span> scanFlags, <span class="type">long</span> currentTime, UserHandle user)</span></span><br><span class="line">        <span class="keyword">throws</span> PackageManagerException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">scanFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(pkg.codePath);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×】处理包名为 &quot;android&quot; 的 apk，也就是 framework-res.apk，属于系统平台包！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.packageName.equals(<span class="string">&quot;android&quot;</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAndroidApplication != <span class="literal">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;*************************************************&quot;</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Core android package being redefined.  Skipping.&quot;</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot; file=&quot;</span> + scanFile);</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;*************************************************&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                        <span class="string">&quot;Core android package being redefined.  Skipping.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; <span class="comment">// 进入该分支，设置系统平台包相关的属性！</span></span><br><span class="line">                <span class="comment">// Set up information for our fall-back user intent resolution activity.</span></span><br><span class="line">                mPlatformPackage = pkg;</span><br><span class="line">                pkg.mVersionCode = mSdkVersion;</span><br><span class="line">                mAndroidApplication = pkg.applicationInfo;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mResolverReplaced) &#123; <span class="comment">// 建立 ResolverActivity 的内存对象。</span></span><br><span class="line">                    mResolveActivity.applicationInfo = mAndroidApplication;</span><br><span class="line">                    mResolveActivity.name = ResolverActivity.class.getName();</span><br><span class="line">                    mResolveActivity.packageName = mAndroidApplication.packageName;</span><br><span class="line">                    mResolveActivity.processName = <span class="string">&quot;system:ui&quot;</span>;</span><br><span class="line">                    mResolveActivity.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">                    mResolveActivity.documentLaunchMode = ActivityInfo.DOCUMENT_LAUNCH_NEVER;</span><br><span class="line">                    mResolveActivity.flags = ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">                    mResolveActivity.theme = R.style.Theme_Material_Dialog_Alert;</span><br><span class="line">                    mResolveActivity.exported = <span class="literal">true</span>;</span><br><span class="line">                    mResolveActivity.enabled = <span class="literal">true</span>;</span><br><span class="line">                    mResolveActivity.resizeMode = ActivityInfo.RESIZE_MODE_RESIZEABLE;</span><br><span class="line">                    mResolveActivity.configChanges = ActivityInfo.CONFIG_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SMALLEST_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SCREEN_LAYOUT</span><br><span class="line">                            | ActivityInfo.CONFIG_ORIENTATION</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD_HIDDEN;</span><br><span class="line">                    mResolveInfo.activityInfo = mResolveActivity;</span><br><span class="line">                    mResolveInfo.priority = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.preferredOrder = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.match = <span class="number">0</span>;</span><br><span class="line">                    mResolveComponentName = <span class="keyword">new</span> <span class="title class_">ComponentName</span>(</span><br><span class="line">                            mAndroidApplication.packageName, mResolveActivity.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Scanning package &quot;</span> + pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】如果 PMS.mPackages 已经包含当前的 Package，说明这个包已经被扫描过了，抛异常，不继续处理！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackages.containsKey(pkg.packageName)</span><br><span class="line">                || mSharedLibraries.containsKey(pkg.packageName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                    <span class="string">&quot;Application package &quot;</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">&quot; already installed.  Skipping duplicate.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 系统 apk 不进入这个分支，SCAN_REQUIRE_KNOWN 只有在扫描 data 分区是才会被设置！！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_REQUIRE_KNOWN) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mExpectingBetter.containsKey(pkg.packageName)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN,</span><br><span class="line">                        <span class="string">&quot;Relax SCAN_REQUIRE_KNOWN requirement for package &quot;</span> + pkg.packageName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">PackageSetting</span> <span class="variable">known</span> <span class="operator">=</span> mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (known != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;Examining &quot;</span> + pkg.codePath</span><br><span class="line">                                + <span class="string">&quot; and requiring known paths &quot;</span> + known.codePathString</span><br><span class="line">                                + <span class="string">&quot; &amp; &quot;</span> + known.resourcePathString);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!pkg.applicationInfo.getCodePath().equals(known.codePathString)</span><br><span class="line">                            || !pkg.applicationInfo.getResourcePath().equals(</span><br><span class="line">                            known.resourcePathString)) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_PACKAGE_CHANGED,</span><br><span class="line">                                <span class="string">&quot;Application package &quot;</span> + pkg.packageName</span><br><span class="line">                                        + <span class="string">&quot; found at &quot;</span> + pkg.applicationInfo.getCodePath()</span><br><span class="line">                                        + <span class="string">&quot; but expected at &quot;</span> + known.codePathString</span><br><span class="line">                                        + <span class="string">&quot;; ignoring.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×】获得扫描到的 apk 和资源的路径，下面会用到！</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">destCodeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(pkg.applicationInfo.getCodePath());</span><br><span class="line">    <span class="type">File</span> <span class="variable">destResourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(pkg.applicationInfo.getResourcePath());</span><br><span class="line"></span><br><span class="line">    <span class="type">SharedUserSetting</span> <span class="variable">suid</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">PackageSetting</span> <span class="variable">pkgSetting</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×】系统 apk 才能有 mOriginalPackages，mRealPackage 和 mAdoptPermissions！</span></span><br><span class="line">    <span class="keyword">if</span> (!isSystemApp(pkg)) &#123;</span><br><span class="line">        pkg.mOriginalPackages = <span class="literal">null</span>;</span><br><span class="line">        pkg.mRealPackage = <span class="literal">null</span>;</span><br><span class="line">        pkg.mAdoptPermissions = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getting the package setting may have a side-effect, so if we</span></span><br><span class="line">    <span class="comment">// are only checking if scan would succeed, stash a copy of the</span></span><br><span class="line">    <span class="comment">// old setting to restore at the end.</span></span><br><span class="line">    <span class="type">PackageSetting</span> <span class="variable">nonMutatedPs</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【×】当前的系统 package 是共享 uid 的，要判断其对应的共享 uid 是否存在！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mSharedUserId != <span class="literal">null</span>) &#123;</span><br><span class="line">            suid = mSettings.getSharedUserLPw(pkg.mSharedUserId, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (suid == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                        <span class="string">&quot;Creating application package &quot;</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">&quot; for shared user failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;Shared UserID &quot;</span> + pkg.mSharedUserId + <span class="string">&quot; (uid=&quot;</span> + suid.userId</span><br><span class="line">                            + <span class="string">&quot;): packages=&quot;</span> + suid.packages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.2.1.7.2】获得当前扫描的这个 package 对应的 packageSetting 对象，如果已经存在就直接返回，不存在就创建！</span></span><br><span class="line">        <span class="comment">// 如果 origPackage 不为 null，创建新的需要重命名为源包的名字！</span></span><br><span class="line">        pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,</span><br><span class="line">                destResourceFile, pkg.applicationInfo.nativeLibraryRootDir,</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags,</span><br><span class="line">                user, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                    <span class="string">&quot;Creating application package &quot;</span> + pkg.packageName + <span class="string">&quot; failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×】对于系统 package，如果 origPackage 不为 null，改名为源包的名字！</span></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.origPackage != <span class="literal">null</span>) &#123;</span><br><span class="line">            pkg.setPackageName(origPackage.name);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;New package &quot;</span> + pkgSetting.realName</span><br><span class="line">                    + <span class="string">&quot; renamed to replace old package &quot;</span> + pkgSetting.name;</span><br><span class="line">            reportSettingsProblem(Log.WARN, msg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; <span class="comment">// 如果没有设置 SCAN_CHECK_ONLY，记录本次改名！</span></span><br><span class="line">                mTransferedPackages.add(origPackage.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清空 originPackage 属性！</span></span><br><span class="line">            pkgSetting.origPackage = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; realName != <span class="literal">null</span>) &#123;</span><br><span class="line">            mTransferedPackages.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×】如果当前的系统 apk 被覆盖更新过，就添加 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(pkg.packageName)) &#123; </span><br><span class="line">            pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">            updateSharedLibrariesLPw(pkg, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFoundPolicyFile) &#123;</span><br><span class="line">            <span class="comment">// 给当前的 Package 分配一个标签，用于 seLinux！</span></span><br><span class="line">            SELinuxMMAC.assignSeinfoValue(pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.applicationInfo.uid = pkgSetting.appId;</span><br><span class="line">        pkg.mExtras = pkgSetting;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×】处理 keySet 更新和签名校验！</span></span><br><span class="line">        <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(pkgSetting, scanFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkUpgradeKeySetLP(pkgSetting, pkg)) &#123;</span><br><span class="line">                <span class="comment">// 签名正确，更新本地的签名信息！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 签名异常处理</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                            <span class="string">&quot;Package &quot;</span> + pkg.packageName + <span class="string">&quot; upgrade keys do not match the &quot;</span></span><br><span class="line">                            + <span class="string">&quot;previously installed version&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;System package &quot;</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">&quot; signature changed; retaining data.&quot;</span>;</span><br><span class="line">                    reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不检查 KetSet 更新的话，就直接校验签名！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                verifySignaturesLP(pkgSetting, pkg);</span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果签名校验出现问题，这里会先恢复成本次解析的签名！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                <span class="comment">// 但是如果是 sharedUser 的情况，就会报错！</span></span><br><span class="line">                <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                                          pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(</span><br><span class="line">                                INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES,</span><br><span class="line">                                        <span class="string">&quot;Signature mismatch for shared user: &quot;</span></span><br><span class="line">                                        + pkgSetting.sharedUser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;System package &quot;</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">&quot; signature changed; retaining data.&quot;</span>;</span><br><span class="line">                reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 同样的，只有系统 apk 才能进入该分支，用于权限继承！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; pkg.mAdoptPermissions != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> pkg.mAdoptPermissions.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">origName</span> <span class="operator">=</span> pkg.mAdoptPermissions.get(i);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">PackageSetting</span> <span class="variable">orig</span> <span class="operator">=</span> mSettings.peekPackageLPr(origName);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (verifyPackageUpdateLPr(orig, pkg)) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">&quot;Adopting permissions from &quot;</span> + origName + <span class="string">&quot; to &quot;</span></span><br><span class="line">                                + pkg.packageName);</span><br><span class="line">                        mSettings.transferPermissionsLPw(origName, pkg.packageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是系统 package，设置 isOrphaned 的属性为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(pkg)) &#123;</span><br><span class="line">        pkgSetting.isOrphaned = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;updateSettings&quot;</span>); <span class="comment">// 记录 trace 事件！</span></span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">createIdmapFailed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.pkg != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Note that |user| might be null during the initial boot scan. If a codePath</span></span><br><span class="line">            <span class="comment">// for an app has changed during a boot scan, it&#x27;s due to an app update that&#x27;s</span></span><br><span class="line">            <span class="comment">// part of the system partition and marker changes must be applied to all users.</span></span><br><span class="line">            maybeRenameForeignDexMarkers(pkgSetting.pkg, pkg,</span><br><span class="line">                (user != <span class="literal">null</span>) ? user : UserHandle.ALL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【important】将新创建或者更新后的 PackageSetting 重新添加到 mSettings 中！</span></span><br><span class="line">        mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【important】将本次扫描的 Package 添加到 PMS.mPackages 中去！</span></span><br><span class="line">        mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将当前的 package 从 mSettings.mPackagesToBeCleaned 中移除，防止数据清除！</span></span><br><span class="line">        <span class="keyword">final</span> Iterator&lt;PackageCleanItem&gt; iter = mSettings.mPackagesToBeCleaned.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            <span class="type">PackageCleanItem</span> <span class="variable">item</span> <span class="operator">=</span> iter.next();</span><br><span class="line">            <span class="keyword">if</span> (pkgName.equals(item.packageName)) &#123;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理 package 的第一次安装时间和最近更新时间！</span></span><br><span class="line">        <span class="keyword">if</span> (currentTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags&amp;SCAN_UPDATE_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">            pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scanFileTime != pkgSetting.timeStamp) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ksms.addScannedPackageLPw(pkg); <span class="comment">// 将 package 的 KeySets 添加到 KeySetManagerService 中！</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 处理四大组件！ </span></span><br><span class="line">        <span class="comment">//【1】处理该 Package 中 的 Provider 信息，添加到 PMS.mProviders 中！</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> pkg.providers.size();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.<span class="type">Provider</span> <span class="variable">p</span> <span class="operator">=</span> pkg.providers.get(i);</span><br><span class="line">            p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mProviders.addProvider(p); <span class="comment">// 添加到 PMS.mProviders 中！</span></span><br><span class="line">            p.syncable = p.info.isSyncable;</span><br><span class="line">            <span class="keyword">if</span> (p.info.authority != <span class="literal">null</span>) &#123;</span><br><span class="line">               ... ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">&quot;  Providers: &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】处理该 Package 中的 Service 信息，添加到 PMS.mService 中！</span></span><br><span class="line">        N = pkg.services.size();</span><br><span class="line">        r = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.<span class="type">Service</span> <span class="variable">s</span> <span class="operator">=</span> pkg.services.get(i);</span><br><span class="line">            s.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    s.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mServices.addService(s); <span class="comment">// 添加到 PMS.mServices 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(s.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">&quot;  Services: &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】处理该 Package 中的 BroadcastReceiver 信息,添加到 PMS.mReceivers 中。</span></span><br><span class="line">        N = pkg.receivers.size();</span><br><span class="line">        r = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.<span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> pkg.receivers.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mReceivers.addActivity(a, <span class="string">&quot;receiver&quot;</span>); <span class="comment">// 添加到 PMS.mReceivers 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">&quot;  Receivers: &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】处理该 Package 中的 activity 信息，添加到 PMS.mActivities 中！</span></span><br><span class="line">        N = pkg.activities.size();</span><br><span class="line">        r = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.<span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> pkg.activities.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mActivities.addActivity(a, <span class="string">&quot;activity&quot;</span>); <span class="comment">// 添加到 PMS.mActivities 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">&quot;  Activities: &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】处理该 Package 中的 PermissionGroups 信息，添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">        N = pkg.permissionGroups.size();</span><br><span class="line">        r = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.<span class="type">PermissionGroup</span> <span class="variable">pg</span> <span class="operator">=</span> pkg.permissionGroups.get(i);</span><br><span class="line">            PackageParser.<span class="type">PermissionGroup</span> <span class="variable">cur</span> <span class="operator">=</span> mPermissionGroups.get(pg.info.name);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">curPackageName</span> <span class="operator">=</span> cur == <span class="literal">null</span> ? <span class="literal">null</span> : cur.info.packageName;</span><br><span class="line">            <span class="comment">//【5.1】如果 isPackageUpdate 为 true，说明要更新权限组的信息！</span></span><br><span class="line">            <span class="comment">// 如果 cur 为 null，说明是新添加的权限组信息！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isPackageUpdate</span> <span class="operator">=</span> pg.info.packageName.equals(curPackageName);</span><br><span class="line">            <span class="keyword">if</span> (cur == <span class="literal">null</span> || isPackageUpdate) &#123;</span><br><span class="line">                mPermissionGroups.put(pg.info.name, pg); <span class="comment">// 添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isPackageUpdate) &#123;</span><br><span class="line">                        r.append(<span class="string">&quot;UPD:&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Permission group &quot;</span> + pg.info.name + <span class="string">&quot; from package &quot;</span></span><br><span class="line">                        + pg.info.packageName + <span class="string">&quot; ignored: original from &quot;</span></span><br><span class="line">                        + cur.info.packageName);</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(<span class="string">&quot;DUP:&quot;</span>);</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">&quot;  Permission Groups: &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【6】处理该 Package 中的定义 Permission 和 Permission-tree 信息！</span></span><br><span class="line">        N = pkg.permissions.size();</span><br><span class="line">        r = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.<span class="type">Permission</span> <span class="variable">p</span> <span class="operator">=</span> pkg.permissions.get(i);</span><br><span class="line">            <span class="comment">// 默认取消掉 PermissionInfo.FLAG_INSTALLED 标志位！</span></span><br><span class="line">            p.info.flags &amp;= ~PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.1】设置权限所属的 group，前提是只有 Android5.1 以后才支持 Permission Groups！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                <span class="keyword">if</span> (p.info.group != <span class="literal">null</span> &amp;&amp; p.group == <span class="literal">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Permission &quot;</span> + p.info.name + <span class="string">&quot; from package &quot;</span></span><br><span class="line">                            + p.info.packageName + <span class="string">&quot; in an unknown group &quot;</span> + p.info.group);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.2】从 Settings 中获得权限管理集合，如果该权限是一个 Permission-tree，</span></span><br><span class="line">            <span class="comment">// 那就返回 mSettings.mPermissionTrees；否则，返回 mSettings.mPermissions！</span></span><br><span class="line">            ArrayMap&lt;String, BasePermission&gt; permissionMap =</span><br><span class="line">                    p.tree ? mSettings.mPermissionTrees</span><br><span class="line">                            : mSettings.mPermissions;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.3】尝试获得上次安装时该权限对应的 BasePermission 对象！</span></span><br><span class="line">            <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> permissionMap.get(p.info.name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.4】允许系统应用来重新定义非系统权限！</span></span><br><span class="line">            <span class="comment">// 如果上次安装时的 BasePermission 不为 null，但是当前解析的 package 不是上次安装时该权限的定义者！</span></span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="literal">null</span> &amp;&amp; !Objects.equals(bp.sourcePackage, p.info.packageName)) &#123;</span><br><span class="line">                <span class="comment">//【6.4.1】判断上一次安装时，定义该权限的 package 是否是系统应用！</span></span><br><span class="line">                <span class="comment">// 如果是 currentOwnerIsSystem 为 true！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">currentOwnerIsSystem</span> <span class="operator">=</span> (bp.perm != <span class="literal">null</span></span><br><span class="line">                        &amp;&amp; isSystemApp(bp.perm.owner));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果当前解析的定义了该权限的 package 是系统 app，那么进入这里！     </span></span><br><span class="line">                <span class="keyword">if</span> (isSystemApp(p.owner)) &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该权限是一个 BasePermission.TYPE_BUILTIN 系统权限，且 bp.perm 为 null，</span></span><br><span class="line">                    <span class="comment">// 即：拥有者未知，那么这里我们将这个 system package 分配给这个权限！</span></span><br><span class="line">                    <span class="keyword">if</span> (bp.type == BasePermission.TYPE_BUILTIN &amp;&amp; bp.perm == <span class="literal">null</span>) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!currentOwnerIsSystem) &#123;</span><br><span class="line">                    <span class="comment">// 如果上一次安装时，定义该权限的 package 不是系统应用，而定义相同权限的</span></span><br><span class="line">                    <span class="comment">// 本次解析的 package 是系统应用，那么该权限会被系统应用重新定义！</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;New decl &quot;</span> + p.owner + <span class="string">&quot; of permission  &quot;</span></span><br><span class="line">                                + p.info.name + <span class="string">&quot; is system; overriding &quot;</span> + bp.sourcePackage;</span><br><span class="line">                        reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                        <span class="comment">// 设置 bp 为 null！</span></span><br><span class="line">                        bp = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为 bp 为 null，所谓我们会使用系统应用重新定义权限，如果是 permission-tree，会被添加到 </span></span><br><span class="line">            <span class="comment">// mSettings.mPermissionTrees 中！</span></span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="literal">null</span>) &#123;</span><br><span class="line">                bp = <span class="keyword">new</span> <span class="title class_">BasePermission</span>(p.info.name, p.info.packageName,</span><br><span class="line">                        BasePermission.TYPE_NORMAL);</span><br><span class="line">                permissionMap.put(p.info.name, bp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重新分配拥有者为该系统应用！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bp.sourcePackage == <span class="literal">null</span></span><br><span class="line">                        || bp.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                    <span class="type">BasePermission</span> <span class="variable">tree</span> <span class="operator">=</span> findPermissionTreeLP(p.info.name);</span><br><span class="line">                    <span class="keyword">if</span> (tree == <span class="literal">null</span></span><br><span class="line">                            || tree.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                                r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            r.append(p.info.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;Permission &quot;</span> + p.info.name + <span class="string">&quot; from package &quot;</span></span><br><span class="line">                                + p.info.packageName + <span class="string">&quot; ignored: base tree &quot;</span></span><br><span class="line">                                + tree.name + <span class="string">&quot; is from package &quot;</span></span><br><span class="line">                                + tree.sourcePackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Permission &quot;</span> + p.info.name + <span class="string">&quot; from package &quot;</span></span><br><span class="line">                            + p.info.packageName + <span class="string">&quot; ignored: original from &quot;</span></span><br><span class="line">                            + bp.sourcePackage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(<span class="string">&quot;DUP:&quot;</span>);</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置 protectionLevel！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == p) &#123;</span><br><span class="line">                bp.protectionLevel = p.info.protectionLevel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">&quot;  Permissions: &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        N = pkg.instrumentation.size();</span><br><span class="line">        r = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            ... ... ... ...<span class="comment">// 这里省略掉，暂时不看！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">&quot;  Instrumentation: &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理该 Package 中的 protectedBroadcasts 信息！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="literal">null</span>) &#123;</span><br><span class="line">            N = pkg.protectedBroadcasts.size();</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkgSetting.setTimeStamp(scanFileTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create idmap files for pairs of (packages, overlay packages).</span></span><br><span class="line">        <span class="comment">// Note: &quot;android&quot;, ie framework-res.apk, is handled by native layers.</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is an overlay package.</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="literal">null</span> &amp;&amp; !pkg.mOverlayTarget.equals(<span class="string">&quot;android&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mOverlays.containsKey(pkg.mOverlayTarget)) &#123;</span><br><span class="line">                    mOverlays.put(pkg.mOverlayTarget,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;String, PackageParser.Package&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">                ArrayMap&lt;String, PackageParser.Package&gt; map = mOverlays.get(pkg.mOverlayTarget);</span><br><span class="line">                map.put(pkg.packageName, pkg);</span><br><span class="line">                PackageParser.<span class="type">Package</span> <span class="variable">orig</span> <span class="operator">=</span> mPackages.get(pkg.mOverlayTarget);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="literal">null</span> &amp;&amp; !createIdmapForPackagePairLI(orig, pkg)) &#123;</span><br><span class="line">                    createIdmapFailed = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOverlays.containsKey(pkg.packageName) &amp;&amp;</span><br><span class="line">                !pkg.packageName.equals(<span class="string">&quot;android&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// This is a regular package, with one or more known overlay packages.</span></span><br><span class="line">            createIdmapsForPackageLI(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (createIdmapFailed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PackageManagerException</span>(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                <span class="string">&quot;scanPackageLI failed to createIdmap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>这里会将解析到的 Packages 和 PackageSetting 添加到对应的集合中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【important】将新创建或者更新后的 PackageSetting 重新添加到 mSettings 中！</span></span><br><span class="line">mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line"><span class="comment">//【important】将本次扫描的 Package 添加到 PMS.mPackages 中去！</span></span><br><span class="line">mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br></pre></td></tr></table></figure>
<h1 id="8-更新权限信息"><a href="#8-更新权限信息" class="headerlink" title="8 更新权限信息"></a>8 更新权限信息</h1><p>在 PMS 的扫描最后阶段 PMS_SCAN_END，会更新权限信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果从我们上次启动，SDK 平台被改变了，我们需要重新授予应用程序权限。</span></span><br><span class="line"><span class="comment">// 这里会有一些安全问题，就是可能会有应用通过这种方式获取那些用户没有显式允许的权限</span></span><br><span class="line"><span class="comment">// 这里可能后续 google 会改善！</span></span><br><span class="line"><span class="type">int</span> <span class="variable">updateFlags</span> <span class="operator">=</span> UPDATE_PERMISSIONS_ALL;</span><br><span class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Platform changed from &quot;</span> + ver.sdkVersion + <span class="string">&quot; to &quot;</span></span><br><span class="line">            + mSdkVersion + <span class="string">&quot;; regranting permissions for internal storage&quot;</span>);</span><br><span class="line">    updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【1】更新系统中的权限和权限树，移除无效的权限和权限树，同时更新应用的权限授予情况！</span></span><br><span class="line">updatePermissionsLPw(<span class="literal">null</span>, <span class="literal">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br></pre></td></tr></table></figure>
<p>这里的最重要的方法是 updatePermissionsLPw 方法：</p>
<h2 id="8-1-PMS-updatePermissionsLPw"><a href="#8-1-PMS-updatePermissionsLPw" class="headerlink" title="8.1 PMS.updatePermissionsLPw"></a>8.1 PMS.updatePermissionsLPw</h2><p>String changingPkg 表示指定的权限发生变化的 package name，可以为 null; PackageParser.Package pkgInfo 表示该 package 的解析信息！</p>
<p>这里的 replaceVolumeUuid 传入的是 StorageManager.UUID_PRIVATE_INTERNAL！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updatePermissionsLPw</span><span class="params">(String changingPkg,</span></span><br><span class="line"><span class="params">        PackageParser.Package pkgInfo, String replaceVolumeUuid, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    <span class="comment">//【1】确保系统中没有失效的权限树；</span></span><br><span class="line">    Iterator&lt;BasePermission&gt; it = mSettings.mPermissionTrees.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> it.next();</span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果 packageSetting 为 null，尝试查找定义的 package！</span></span><br><span class="line">            bp.packageSetting = mSettings.mPackages.get(bp.sourcePackage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】如果找不到定义该权限树的 package，那就移除该 permission-tree！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="literal">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Removing dangling permission tree: &quot;</span> + bp.name</span><br><span class="line">                    + <span class="string">&quot; from package &quot;</span> + bp.sourcePackage);</span><br><span class="line">            it.remove();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (changingPkg != <span class="literal">null</span> &amp;&amp; changingPkg.equals(bp.sourcePackage)) &#123;</span><br><span class="line">            <span class="comment">// 根据参数，不进入这里，但是我们来分析下这部分代码的意思</span></span><br><span class="line">            <span class="comment">// 如果权限的定义者不在定义这个权限了，那就移除该权限的上一次信息！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgInfo == <span class="literal">null</span> || !hasPermission(pkgInfo, bp.name)) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">&quot;Removing old permission tree: &quot;</span> + bp.name</span><br><span class="line">                        + <span class="string">&quot; from package &quot;</span> + bp.sourcePackage);</span><br><span class="line">                flags |= UPDATE_PERMISSIONS_ALL;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】确保系统中所有的动态权限都已经分配给对应的 package，同时系统中也没有失效的权限!</span></span><br><span class="line">    it = mSettings.mPermissions.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> it.next();</span><br><span class="line">        <span class="comment">//【2.1】如果是动态权限，尝试找到其所属的 permission-tree，并绑定到定义了 tree 的 package 上！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.type == BasePermission.TYPE_DYNAMIC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SETTINGS) Log.v(TAG, <span class="string">&quot;Dynamic permission: name=&quot;</span></span><br><span class="line">                    + bp.name + <span class="string">&quot; pkg=&quot;</span> + bp.sourcePackage</span><br><span class="line">                    + <span class="string">&quot; info=&quot;</span> + bp.pendingInfo);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bp.packageSetting == <span class="literal">null</span> &amp;&amp; bp.pendingInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">BasePermission</span> <span class="variable">tree</span> <span class="operator">=</span> findPermissionTreeLP(bp.name);</span><br><span class="line">                <span class="keyword">if</span> (tree != <span class="literal">null</span> &amp;&amp; tree.perm != <span class="literal">null</span>) &#123;</span><br><span class="line">                    bp.packageSetting = tree.packageSetting;</span><br><span class="line">                    bp.perm = <span class="keyword">new</span> <span class="title class_">PackageParser</span>.Permission(tree.perm.owner,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">PermissionInfo</span>(bp.pendingInfo));</span><br><span class="line">                    bp.perm.info.packageName = tree.perm.info.packageName;</span><br><span class="line">                    bp.perm.info.name = bp.name;</span><br><span class="line">                    bp.uid = tree.uid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】如果权限的定义者为 null，尝试在系统中找到定义者！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="literal">null</span>) &#123;</span><br><span class="line">            bp.packageSetting = mSettings.mPackages.get(bp.sourcePackage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.3】如果依然找不到定义该权限的 package，那就移除该 permission ！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="literal">null</span>) &#123; <span class="comment">// 该权限无效，移除它！</span></span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Removing dangling permission: &quot;</span> + bp.name</span><br><span class="line">                    + <span class="string">&quot; from package &quot;</span> + bp.sourcePackage);</span><br><span class="line">            it.remove();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (changingPkg != <span class="literal">null</span> &amp;&amp; changingPkg.equals(bp.sourcePackage)) &#123; </span><br><span class="line">            <span class="comment">// 根据参数，不进入这里，但是我们来分析下这部分代码的意思</span></span><br><span class="line">            <span class="comment">// 如果权限的定义者不在定义这个权限了，那就移除该权限的上一次信息！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgInfo == <span class="literal">null</span> || !hasPermission(pkgInfo, bp.name)) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">&quot;Removing old permission: &quot;</span> + bp.name</span><br><span class="line">                        + <span class="string">&quot; from package &quot;</span> + bp.sourcePackage);</span><br><span class="line">                flags |= UPDATE_PERMISSIONS_ALL;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 flags 设置了 UPDATE_PERMISSIONS_ALL 标志位，那么就更新除了 changingPkg 以外的其他</span></span><br><span class="line">    <span class="comment">// 所有的 package 的权限授予信息 ，特别是替换系统包的授予权限！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; UPDATE_PERMISSIONS_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (PackageParser.Package pkg : mPackages.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkg != pkgInfo) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">volumeUuid</span> <span class="operator">=</span> getVolumeUuidForPackage(pkg);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">replace</span> <span class="operator">=</span> ((flags &amp; UPDATE_PERMISSIONS_REPLACE_ALL) != <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line">                <span class="comment">//【3.1】重新授予权限！</span></span><br><span class="line">                grantPermissionsLPw(pkg, replace, changingPkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】因为这里 pkgInfo 为 null，所以不进入这里！</span></span><br><span class="line">    <span class="comment">// 这里的逻辑是，如果 changingPkg 不为 null，最后也会更新其权限的授予信息！</span></span><br><span class="line">    <span class="keyword">if</span> (pkgInfo != <span class="literal">null</span>) &#123; </span><br><span class="line">        <span class="comment">// Only replace for packages on requested volume</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">volumeUuid</span> <span class="operator">=</span> getVolumeUuidForPackage(pkgInfo);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">replace</span> <span class="operator">=</span> ((flags &amp; UPDATE_PERMISSIONS_REPLACE_PKG) != <span class="number">0</span>)</span><br><span class="line">                &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line">        grantPermissionsLPw(pkgInfo, replace, changingPkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里就分析到这里！</p>
<h1 id="9-持久化权限相关信息"><a href="#9-持久化权限相关信息" class="headerlink" title="9 持久化权限相关信息"></a>9 持久化权限相关信息</h1><p>核心方法是在 Settings.writeLPr 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Settings.writeLPr</span><br></pre></td></tr></table></figure>
<p>下面我们来看下：</p>
<h2 id="9-1-Settings-writeLPr"><a href="#9-1-Settings-writeLPr" class="headerlink" title="9.1 Settings.writeLPr"></a>9.1 Settings.writeLPr</h2><p>将解析到的安装数据写回到 packages.xml 等文件中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">writeLPr</span><span class="params">()</span> &#123;</span><br><span class="line">    Debug.startMethodTracing(<span class="string">&quot;/data/system/packageprof&quot;</span>, <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//【1】下面会先将最新的数据写入到 packages-backup.xml 文件中！</span></span><br><span class="line">    <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mBackupSettingsFilename.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettingsFilename.renameTo(mBackupSettingsFilename)) &#123;</span><br><span class="line">                Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                        <span class="string">&quot;Unable to backup package manager settings, &quot;</span></span><br><span class="line">                        + <span class="string">&quot; current changes will be lost at reboot&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSettingsFilename.delete();</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">&quot;Preserving older settings backup&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPastSignatures.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fstr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(mSettingsFilename);</span><br><span class="line">        <span class="type">BufferedOutputStream</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fstr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//XmlSerializer serializer = XmlUtils.serializerInstance();</span></span><br><span class="line">        <span class="type">XmlSerializer</span> <span class="variable">serializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastXmlSerializer</span>();</span><br><span class="line">        serializer.setOutput(str, StandardCharsets.UTF_8.name());</span><br><span class="line">        serializer.startDocument(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">        serializer.setFeature(<span class="string">&quot;http://xmlpull.org/v1/doc/features.html#indent-output&quot;</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="literal">null</span>, <span class="string">&quot;packages&quot;</span>); <span class="comment">//【2】写入 &quot;packages&quot;！</span></span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="literal">null</span>, <span class="string">&quot;permission-trees&quot;</span>); <span class="comment">//【3】写入 &quot;permission-trees&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (BasePermission bp : mPermissionTrees.values()) &#123;</span><br><span class="line">            writePermissionLPr(serializer, bp);</span><br><span class="line">        &#125;</span><br><span class="line">        serializer.endTag(<span class="literal">null</span>, <span class="string">&quot;permission-trees&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="literal">null</span>, <span class="string">&quot;permissions&quot;</span>); <span class="comment">//【4】写入 &quot;permissions&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (BasePermission bp : mPermissions.values()) &#123;</span><br><span class="line">            writePermissionLPr(serializer, bp);</span><br><span class="line">        &#125;</span><br><span class="line">        serializer.endTag(<span class="literal">null</span>, <span class="string">&quot;permissions&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mPackages.values()) &#123; <span class="comment">//【5】写入 &quot;package&quot;</span></span><br><span class="line">            writePackageLPr(serializer, pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mDisabledSysPackages.values()) &#123; <span class="comment">//【6】写入 &quot;updated-package&quot;</span></span><br><span class="line">            writeDisabledSysPackageLPr(serializer, pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> SharedUserSetting usr : mSharedUsers.values()) &#123; <span class="comment">//【7】写入 &quot;shared-user&quot;</span></span><br><span class="line">            serializer.startTag(<span class="literal">null</span>, <span class="string">&quot;shared-user&quot;</span>);</span><br><span class="line">            serializer.attribute(<span class="literal">null</span>, ATTR_NAME, usr.name);</span><br><span class="line">            serializer.attribute(<span class="literal">null</span>, <span class="string">&quot;userId&quot;</span>,</span><br><span class="line">                    Integer.toString(usr.userId));</span><br><span class="line">            usr.signatures.writeXml(serializer, <span class="string">&quot;sigs&quot;</span>, mPastSignatures);</span><br><span class="line">            <span class="comment">// 写入 shared-user 的安装时权限！</span></span><br><span class="line">            writePermissionsLPr(serializer, usr.getPermissionsState()</span><br><span class="line">                    .getInstallPermissionStates());</span><br><span class="line">            serializer.endTag(<span class="literal">null</span>, <span class="string">&quot;shared-user&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line"></span><br><span class="line">        serializer.endTag(<span class="literal">null</span>, <span class="string">&quot;packages&quot;</span>); <span class="comment">// 结束 packages-backup.xml 文件的写入！</span></span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        writePackageListLPr(); <span class="comment">// 写入 packageslist 文件！</span></span><br><span class="line">        writeAllUsersPackageRestrictionsLPr(); <span class="comment">// 写入偏好设置信息；</span></span><br><span class="line">        writeAllRuntimePermissionsLPr(); <span class="comment">//【8】写入运行时权限授予信息！</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>(XmlPullParserException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">&quot;Unable to write package manager settings, &quot;</span></span><br><span class="line">                + <span class="string">&quot;current changes will be lost at reboot&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(java.io.IOException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">&quot;Unable to write package manager settings, &quot;</span></span><br><span class="line">                + <span class="string">&quot;current changes will be lost at reboot&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Clean up partially written files</span></span><br><span class="line">    <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mSettingsFilename.delete()) &#123;</span><br><span class="line">            Slog.wtf(PackageManagerService.TAG, <span class="string">&quot;Failed to clean up mangled file: &quot;</span></span><br><span class="line">                    + mSettingsFilename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里我们可以看到，整个的写入顺序！</p>
<h1 id="10-默认运行时权限授予"><a href="#10-默认运行时权限授予" class="headerlink" title="10 默认运行时权限授予"></a>10 默认运行时权限授予</h1><p>在开机的最后阶段，PMS 会通过 DefaultPermissionGrantPolicy.grantDefaultPermissions 方法来默认授予一些系统应用运行所必须的系统权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> userId : grantPermissionsUserIds) &#123;</span><br><span class="line">    mDefaultPermissionPolicy.grantDefaultPermissions(userId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果没有默认授予运行时权限给指定的 userId，那么我们会直接读取 default-permissions 目录中的文件</span></span><br><span class="line"><span class="comment">// 初始化 mGrantExceptions，和上面的过程类似，不关注！</span></span><br><span class="line"><span class="keyword">if</span> (grantPermissionsUserIds == EMPTY_INT_ARRAY) &#123;</span><br><span class="line">    mDefaultPermissionPolicy.scheduleReadDefaultPermissionExceptions();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Li Shuaiqi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2017/05/13/Permission2-packageManagerInitPermission/">https://lishuaiqi.top/2017/05/13/Permission2-packageManagerInitPermission/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Li Shuaiqi's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Permission%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/">Permission权限管理</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/05/23/AlarmManager1-AlarmManagerServiceStartProcess/"><i class="fa fa-chevron-left">  </i><span>AlarmManager第 1 篇 - AlarmManagerService启动</span></a></div><div class="next-post pull-right"><a href="/2017/05/09/Permission1-permissionSettingsAndParse/"><span>Permission第 1 篇 - Permission 配置和解析</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  id: md5(decodeURI(location.pathname)),
  owner: '',
  repo: '',
  oauth: {
    client_id: '7b4efbcd7027d15749d6',
    client_secret: '14b5d7e8580ee29f7aeca733a25c000795967448'
  }
})
gitment.render('gitment-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2025 By Li Shuaiqi</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>