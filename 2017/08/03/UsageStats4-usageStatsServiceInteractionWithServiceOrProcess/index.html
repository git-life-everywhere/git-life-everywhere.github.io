<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互"><meta name="keywords" content="UsageStats使用状态管理"><meta name="author" content="Li Shuaiqi"><meta name="copyright" content="Li Shuaiqi"><title>UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互 | Li Shuaiqi's Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '8.0.0'
} </script><meta name="generator" content="Hexo 8.0.0"><link rel="alternate" href="/atom.xml" title="Li Shuaiqi's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E7%BB%BC%E8%BF%B0"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%92%8C-UsageStatsService-%E9%80%9A%E4%BF%A1%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-text">1 和 UsageStatsService 通信的服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ActivityManagerService"><span class="toc-text">2 ActivityManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-updateUsageStats"><span class="toc-text">2.1 updateUsageStats</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-text">2.1.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E6%96%B9%E6%B3%95%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">2.1.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-LocalService-reportEvent"><span class="toc-text">2.1.3 LocalService.reportEvent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-updateConfigurationLocked"><span class="toc-text">2.2 updateConfigurationLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-text">2.2.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E6%96%B9%E6%B3%95%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">2.2.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-LocalService-updateConfigurationLocked"><span class="toc-text">2.2.3 LocalService.updateConfigurationLocked</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-maybeUpdateProviderUsageStatsLocked"><span class="toc-text">2.3 maybeUpdateProviderUsageStatsLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-text">2.3.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E6%96%B9%E6%B3%95%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">2.3.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-LocalService-reportContentProviderUsage"><span class="toc-text">2.3.3 LocalService.reportContentProviderUsage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-maybeUpdateUsageStatsLocked"><span class="toc-text">2.4 maybeUpdateUsageStatsLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-text">2.4.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-%E6%96%B9%E6%B3%95%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">2.4.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-LocalService-reportEvent"><span class="toc-text">2.4.3 LocalService.reportEvent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-shutdown"><span class="toc-text">2.5 shutdown</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-NotificationManagerService"><span class="toc-text">3 NotificationManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-onStart"><span class="toc-text">3.1 onStart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-setNotificationsShownFromListener"><span class="toc-text">3.2 setNotificationsShownFromListener</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-NetworkPolicyManagerService"><span class="toc-text">4 NetworkPolicyManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-systemReady"><span class="toc-text">4.1 systemReady</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-new-AppIdleStateChangeListener"><span class="toc-text">4.2 new AppIdleStateChangeListener</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-App-Idle-State-Changed"><span class="toc-text">4.3 App Idle State Changed</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-updateRuleForAppIdleUL"><span class="toc-text">4.3.1 updateRuleForAppIdleUL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-1-setUidFirewallRule"><span class="toc-text">4.3.1.1 setUidFirewallRule</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-updateRulesForPowerRestrictionsUL-1"><span class="toc-text">4.3.2 updateRulesForPowerRestrictionsUL[1]</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Parole-State-Changed"><span class="toc-text">4.4 Parole State Changed</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-updateRulesForAppIdleParoleUL"><span class="toc-text">4.4.1 updateRulesForAppIdleParoleUL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-updateRulesForPowerRestrictionsUL-3"><span class="toc-text">4.4.2 updateRulesForPowerRestrictionsUL[3]</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-AppIdleController"><span class="toc-text">5 AppIdleController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-new-AppIdleController"><span class="toc-text">5.1 new AppIdleController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-new-AppIdleStateChangeListener"><span class="toc-text">5.2 new AppIdleStateChangeListener</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-PackageUpdateFunc-process"><span class="toc-text">5.2.1 PackageUpdateFunc.process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-setAppIdleParoleOn"><span class="toc-text">5.2.2 setAppIdleParoleOn</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-1-GlobalUpdateFunc-process"><span class="toc-text">5.2.2.1 GlobalUpdateFunc.process</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-maybeStartTrackingJobLocked"><span class="toc-text">5.3 maybeStartTrackingJobLocked</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Li Shuaiqi</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师。”</div><div class="follow-button"><a href="https://lishuaiqi.top">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">96</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">26</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">30</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">one more thing</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://juejin.cn/post/7366896388658593803">小二哥的 Android 站</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Li Shuaiqi's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/UsageStats%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/">UsageStats使用状态管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 29 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android7.1.1 源码分析 UsageStatsService 的架构和原理！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>本文主要分析 UsageStatsService 和其他服务 / 进程交互！</p>
<p>我们知道 UsageStatsService 内部有两个类 LocalService 和 BinderService，他们是 UsageStatsService 提供給其他服务或进程的通信接口类！</p>
<ul>
<li><strong>BinderService</strong></li>
</ul>
<p>BinderService 主要用于跨进程调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BinderService</span> <span class="keyword">extends</span> <span class="title class_">IUsageStatsManager</span>.Stub &#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>BinderService 继承了 IUsageStatsManager.Stub，作为服务端桩对象，注册进 ServiceManager！</p>
<p>我们在其他进程中可以通过 UsageStatsManager 来获得客户端代理对象！</p>
<ul>
<li><strong>LocalService</strong></li>
</ul>
<p>LocalService 用于系统进程中的其他服务调用，比如 ActivityManagerService，NotificationManagerService 等服务，下面是一些主要接口的调用逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LocalService.reportEvent                 -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportConfigurationChange   -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportShortcutUsage         -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportContentProviderUsage  -&gt; UsageStatsService.H.MSG_REPORT_CONTENT_PROVIDER_USAGE</span><br><span class="line"></span><br><span class="line">LocalService.isAppIdle                   -&gt; UsageStatsService.isAppIdleFiltered</span><br><span class="line">LocalService.getIdleUidsForUser          -&gt; UsageStatsService.getIdleUidsForUse</span><br><span class="line">LocalService.isAppIdleParoleOn           -&gt; UsageStatsService.isParoledOrCharging</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LocalService.addAppIdleStateChangeListener  -&gt; UsageStatsService.addListener</span><br></pre></td></tr></table></figure>
<p>我们重点关注 LocalService 的逻辑调用！</p>
<h1 id="1-和-UsageStatsService-通信的服务"><a href="#1-和-UsageStatsService-通信的服务" class="headerlink" title="1 和 UsageStatsService 通信的服务"></a>1 和 UsageStatsService 通信的服务</h1><ul>
<li><strong>ActivityManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService.setUsageStatsManager(</span><br><span class="line">        LocalServices.getService(UsageStatsManagerInternal.class));</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>NotificationManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    mAppUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    ... ... ..</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>NetworkPolicyManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">systemReady</span><span class="params">()</span> &#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_NETWORK, <span class="string">&quot;systemReady&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isBandwidthControlEnabled()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;bandwidth controls disabled, unable to enforce policy&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>AppIdleController</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    mAppIdleParoleOn = <span class="literal">true</span>;</span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> <span class="title class_">AppIdleStateChangeListener</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要有以上的服务！</p>
<h1 id="2-ActivityManagerService"><a href="#2-ActivityManagerService" class="headerlink" title="2 ActivityManagerService"></a>2 ActivityManagerService</h1><p>ActivityManagerService 和 UsageStatsService 交互可算是重头戏！</p>
<h2 id="2-1-updateUsageStats"><a href="#2-1-updateUsageStats" class="headerlink" title="2.1 updateUsageStats"></a>2.1 updateUsageStats</h2><p>updateUsageStats 方法用于更新 Activity 的使用信息！</p>
<h3 id="2-1-1-调用时机"><a href="#2-1-1-调用时机" class="headerlink" title="2.1.1 调用时机"></a>2.1.1 调用时机</h3><p>我们来看看调用时机：</p>
<ul>
<li><strong>ActivityStack.startPausingLocked</strong></li>
</ul>
<p>当 activty 进入 paused 状态的时候，会触发 startPausingLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">startPausingLocked</span><span class="params">(<span class="type">boolean</span> userLeaving, <span class="type">boolean</span> uiSleeping,</span></span><br><span class="line"><span class="params">        ActivityRecord resuming, <span class="type">boolean</span> dontWait)</span> &#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev.app != <span class="literal">null</span> &amp;&amp; prev.app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">&quot;Enqueueing pending pause: &quot;</span> + prev);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,</span><br><span class="line">                    prev.userId, System.identityHashCode(prev),</span><br><span class="line">                    prev.shortComponentName);</span><br><span class="line">            <span class="comment">//【2.1.2】记录 activity 组件的 UsageEvents.Event.MOVE_TO_BACKGROUND 事件！</span></span><br><span class="line">            mService.updateUsageStats(prev, <span class="literal">false</span>);</span><br><span class="line">            <span class="comment">//【1】拉起 activity 的 onPause 方法！</span></span><br><span class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                    userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Ignore exception, if process died other code will cleanup.</span></span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Exception thrown during pause&quot;</span>, e);</span><br><span class="line">            mPausingActivity = <span class="literal">null</span>;</span><br><span class="line">            mLastPausedActivity = <span class="literal">null</span>;</span><br><span class="line">            mLastNoHistoryActivity = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mPausingActivity = <span class="literal">null</span>;</span><br><span class="line">        mLastPausedActivity = <span class="literal">null</span>;</span><br><span class="line">        mLastNoHistoryActivity = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityStackSupervisor.reportResumedActivityLocked</strong></li>
</ul>
<p>当 activty 进入 resume 状态的时候，会触发 reportResumedActivityLocked 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">reportResumedActivityLocked</span><span class="params">(ActivityRecord r)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityStack</span> <span class="variable">stack</span> <span class="operator">=</span> r.task.stack;</span><br><span class="line">    <span class="keyword">if</span> (isFocusedStack(stack)) &#123;</span><br><span class="line">        <span class="comment">//【2.1.2】记录 activity 组件的 UsageEvents.Event.MOVE_TO_FOREGROUND 事件！</span></span><br><span class="line">        mService.updateUsageStats(r, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allResumedActivitiesComplete()) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="literal">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">        mWindowManager.executeAppTransition();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>ActivityStack.handleAppDiedLocked</strong></li>
</ul>
<p>当 app process 死亡后，会触发 ActivityStack.handleAppDiedLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">handleAppDiedLocked</span><span class="params">(ProcessRecord app)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPausingActivity != <span class="literal">null</span> &amp;&amp; mPausingActivity.app == app) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE || DEBUG_CLEANUP) Slog.v(TAG_PAUSE,</span><br><span class="line">                <span class="string">&quot;App died while pausing: &quot;</span> + mPausingActivity);</span><br><span class="line">        mPausingActivity = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLastPausedActivity != <span class="literal">null</span> &amp;&amp; mLastPausedActivity.app == app) &#123;</span><br><span class="line">        mLastPausedActivity = <span class="literal">null</span>;</span><br><span class="line">        mLastNoHistoryActivity = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】调用自身的 removeHistoryRecordsForAppLocked 方法！</span></span><br><span class="line">    <span class="keyword">return</span> removeHistoryRecordsForAppLocked(app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入 removeHistoryRecordsForAppLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">removeHistoryRecordsForAppLocked</span><span class="params">(ProcessRecord app)</span> &#123;</span><br><span class="line">     ... ... ...</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">taskNdx</span> <span class="operator">=</span> mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">         <span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; activities = mTaskHistory.get(taskNdx).mActivities;</span><br><span class="line">         <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">activityNdx</span> <span class="operator">=</span> activities.size() - <span class="number">1</span>; activityNdx &gt;= <span class="number">0</span>; --activityNdx) &#123;</span><br><span class="line">             <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> activities.get(activityNdx);</span><br><span class="line">             --i;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_CLEANUP) Slog.v(TAG_CLEANUP,</span><br><span class="line">                     <span class="string">&quot;Record #&quot;</span> + i + <span class="string">&quot; &quot;</span> + r + <span class="string">&quot;: app=&quot;</span> + r.app);</span><br><span class="line">             <span class="keyword">if</span> (r.app == app) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r.visible) &#123;</span><br><span class="line">                     hasVisibleActivities = <span class="literal">true</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">final</span> <span class="type">boolean</span> remove;</span><br><span class="line">                 ... ... ...</span><br><span class="line">                 <span class="keyword">if</span> (remove) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (DEBUG_ADD_REMOVE || DEBUG_CLEANUP) Slog.i(TAG_ADD_REMOVE,</span><br><span class="line">                             <span class="string">&quot;Removing activity &quot;</span> + r + <span class="string">&quot; from stack at &quot;</span> + i</span><br><span class="line">                             + <span class="string">&quot;: haveState=&quot;</span> + r.haveState</span><br><span class="line">                             + <span class="string">&quot; stateNotNeeded=&quot;</span> + r.stateNotNeeded</span><br><span class="line">                             + <span class="string">&quot; finishing=&quot;</span> + r.finishing</span><br><span class="line">                             + <span class="string">&quot; state=&quot;</span> + r.state + <span class="string">&quot; callers=&quot;</span> + Debug.getCallers(<span class="number">5</span>));</span><br><span class="line">                     <span class="keyword">if</span> (!r.finishing) &#123;</span><br><span class="line">                         Slog.w(TAG, <span class="string">&quot;Force removing &quot;</span> + r + <span class="string">&quot;: app died, no saved state&quot;</span>);</span><br><span class="line">                         EventLog.writeEvent(EventLogTags.AM_FINISH_ACTIVITY,</span><br><span class="line">                                 r.userId, System.identityHashCode(r),</span><br><span class="line">                                 r.task.taskId, r.shortComponentName,</span><br><span class="line">                                 <span class="string">&quot;proc died without state saved&quot;</span>);</span><br><span class="line">                         <span class="keyword">if</span> (r.state == ActivityState.RESUMED) &#123;</span><br><span class="line">                             <span class="comment">//【2.2.2】如果 activity 处于 resume 状态，记录状态！</span></span><br><span class="line">                             mService.updateUsageStats(r, <span class="literal">false</span>);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     ... ... ..</span><br><span class="line">                 &#125;</span><br><span class="line">                 ... ... ...</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> hasVisibleActivities;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，不多说！</p>
<h3 id="2-1-2-方法流程分析"><a href="#2-1-2-方法流程分析" class="headerlink" title="2.1.2 方法流程分析"></a>2.1.2 方法流程分析</h3><p>参数 boolean resumed 表示是否处于 resume 状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateUsageStats</span><span class="params">(ActivityRecord component, <span class="type">boolean</span> resumed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SWITCH) Slog.d(TAG_SWITCH,</span><br><span class="line">            <span class="string">&quot;updateUsageStats: comp=&quot;</span> + component + <span class="string">&quot;res=&quot;</span> + resumed);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">BatteryStatsImpl</span> <span class="variable">stats</span> <span class="operator">=</span> mBatteryStatsService.getActiveStatistics();</span><br><span class="line">    <span class="keyword">if</span> (resumed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUsageStatsService != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1.3】如果是 resume 状态，记录 UsageEvents.Event.MOVE_TO_FOREGROUND 事件！</span></span><br><span class="line">            mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                    UsageEvents.Event.MOVE_TO_FOREGROUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">            stats.noteActivityResumedLocked(component.app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUsageStatsService != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1.3】如果不是 resume 状态，记录 UsageEvents.Event.MOVE_TO_BACKGROUND 事件！</span></span><br><span class="line">            mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                    UsageEvents.Event.MOVE_TO_BACKGROUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">            stats.noteActivityPausedLocked(component.app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="2-1-3-LocalService-reportEvent"><a href="#2-1-3-LocalService-reportEvent" class="headerlink" title="2.1.3 LocalService.reportEvent"></a>2.1.3 LocalService.reportEvent</h3><p>这里最终调用了 reportEvent 方法，传入的 ComponentName component 为 Activity！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reportEvent</span><span class="params">(ComponentName component, <span class="type">int</span> userId, <span class="type">int</span> eventType)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="literal">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;Event reported without a component name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.<span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsageEvents</span>.Event();</span><br><span class="line">    event.mPackage = component.getPackageName();</span><br><span class="line">    event.mClass = component.getClassName();</span><br><span class="line"></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = eventType;</span><br><span class="line">    <span class="comment">//【1】发送了 MSG_REPORT_EVENT 消息！</span></span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>不多说了！</p>
<h2 id="2-2-updateConfigurationLocked"><a href="#2-2-updateConfigurationLocked" class="headerlink" title="2.2 updateConfigurationLocked"></a>2.2 updateConfigurationLocked</h2><h3 id="2-2-1-调用时机"><a href="#2-2-1-调用时机" class="headerlink" title="2.2.1 调用时机"></a>2.2.1 调用时机</h3><p>主要是和 Configuration 配置更新相关的内容，调用地方过多，这里先不列出！</p>
<h3 id="2-2-2-方法流程分析"><a href="#2-2-2-方法流程分析" class="headerlink" title="2.2.2 方法流程分析"></a>2.2.2 方法流程分析</h3><p>和 updateConfigurationLocked 相关的有多个重载函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateConfiguration</span><span class="params">(Configuration values)</span> &#123;</span><br><span class="line">    enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</span><br><span class="line">            <span class="string">&quot;updateConfiguration()&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (values == <span class="literal">null</span> &amp;&amp; mWindowManager != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// sentinel: fetch the current configuration from the window manager</span></span><br><span class="line">            values = mWindowManager.computeNewConfiguration();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWindowManager != <span class="literal">null</span>) &#123;</span><br><span class="line">            mProcessList.applyDisplaySize(mWindowManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">if</span> (values != <span class="literal">null</span>) &#123;</span><br><span class="line">            Settings.System.clearConfiguration(values);</span><br><span class="line">        &#125;</span><br><span class="line">        updateConfigurationLocked(values, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">updateUserConfigurationLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(mConfiguration);</span><br><span class="line">    Settings.System.adjustConfigurationForUser(mContext.getContentResolver(), configuration,</span><br><span class="line">            mUserController.getCurrentUserIdLocked(), Settings.System.canWrite(mContext));</span><br><span class="line">    updateConfigurationLocked(configuration, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> initLocale)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> updateConfigurationLocked(values, starting, initLocale, <span class="literal">false</span> <span class="comment">/* deferResume */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> initLocale, <span class="type">boolean</span> deferResume)</span> &#123;</span><br><span class="line">    <span class="comment">// pass UserHandle.USER_NULL as userId because we don&#x27;t persist configuration for any user</span></span><br><span class="line">    <span class="keyword">return</span> updateConfigurationLocked(values, starting, initLocale, <span class="literal">false</span> <span class="comment">/* persistent */</span>,</span><br><span class="line">            UserHandle.USER_NULL, deferResume);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateConfigurationLocked 方法用于更新指定 activity 的 Configuration 属性，主要有两个作用：</p>
<ul>
<li>改变当前的配置；</li>
<li>确保指定的 activity 使用的是当前最新的 activity；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> initLocale, <span class="type">boolean</span> persistent, <span class="type">int</span> userId, <span class="type">boolean</span> deferResume)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">changes</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//【1】停止布局！</span></span><br><span class="line">    <span class="keyword">if</span> (mWindowManager != <span class="literal">null</span>) &#123;</span><br><span class="line">        mWindowManager.deferSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】处理配置变化！</span></span><br><span class="line">    <span class="keyword">if</span> (values != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】获得旧配置的拷贝；</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">newConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(mConfiguration);</span><br><span class="line">        <span class="comment">//【2.2】获得配置的更新信息！</span></span><br><span class="line">        changes = newConfig.updateFrom(values);</span><br><span class="line">        <span class="keyword">if</span> (changes != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_CONFIGURATION) Slog.i(TAG_CONFIGURATION,</span><br><span class="line">                    <span class="string">&quot;Updating configuration to: &quot;</span> + values);</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.CONFIGURATION_CHANGED, changes);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.3】处理多语言的更新！</span></span><br><span class="line">            <span class="keyword">if</span> (!initLocale &amp;&amp; !values.getLocales().isEmpty() &amp;&amp; values.userSetLocale) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">LocaleList</span> <span class="variable">locales</span> <span class="operator">=</span> values.getLocales();</span><br><span class="line">                <span class="type">int</span> <span class="variable">bestLocaleIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (locales.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mSupportedSystemLocales == <span class="literal">null</span>) &#123;</span><br><span class="line">                        mSupportedSystemLocales =</span><br><span class="line">                                Resources.getSystem().getAssets().getLocales();</span><br><span class="line">                    &#125;</span><br><span class="line">                    bestLocaleIndex = Math.max(<span class="number">0</span>,</span><br><span class="line">                            locales.getFirstMatchIndex(mSupportedSystemLocales));</span><br><span class="line">                &#125;</span><br><span class="line">                SystemProperties.set(<span class="string">&quot;persist.sys.locale&quot;</span>,</span><br><span class="line">                        locales.get(bestLocaleIndex).toLanguageTag());</span><br><span class="line">                LocaleList.setDefault(locales, bestLocaleIndex);</span><br><span class="line">                mHandler.sendMessage(mHandler.obtainMessage(SEND_LOCALE_TO_MOUNT_DAEMON_MSG,</span><br><span class="line">                        locales.get(bestLocaleIndex)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.4】计算本次更新的序列号；</span></span><br><span class="line">            mConfigurationSeq++;</span><br><span class="line">            <span class="keyword">if</span> (mConfigurationSeq &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mConfigurationSeq = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.5】更新配置引用对象！</span></span><br><span class="line">            newConfig.seq = mConfigurationSeq;</span><br><span class="line">            mConfiguration = newConfig;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;Config changes=&quot;</span> + Integer.toHexString(changes) + <span class="string">&quot; &quot;</span> + newConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【×2.2.3】调用 reportConfigurationChange 方法！</span></span><br><span class="line">            mUsageStatsService.reportConfigurationChange(newConfig,</span><br><span class="line">                    mUserController.getCurrentUserIdLocked());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Configuration</span> <span class="variable">configCopy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(mConfiguration);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> If our config changes, should we auto dismiss any currently</span></span><br><span class="line">            <span class="comment">// showing dialogs?</span></span><br><span class="line">            mShowDialogs = shouldShowDialogs(newConfig, mInVrMode);</span><br><span class="line"></span><br><span class="line">            <span class="type">AttributeCache</span> <span class="variable">ac</span> <span class="operator">=</span> AttributeCache.instance();</span><br><span class="line">            <span class="keyword">if</span> (ac != <span class="literal">null</span>) &#123;</span><br><span class="line">                ac.updateConfiguration(configCopy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.6】更新资源配置！</span></span><br><span class="line">            mSystemThread.applyConfigurationToResources(configCopy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (persistent &amp;&amp; Settings.System.hasInterestingConfigurationChanges(changes)) &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(UPDATE_CONFIGURATION_MSG);</span><br><span class="line">                msg.obj = <span class="keyword">new</span> <span class="title class_">Configuration</span>(configCopy);</span><br><span class="line">                msg.arg1 = userId;</span><br><span class="line">                mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.7】调整屏幕密度改变</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isDensityChange</span> <span class="operator">=</span> (changes &amp; ActivityInfo.CONFIG_DENSITY) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (isDensityChange) &#123;</span><br><span class="line">                <span class="comment">// Reset the unsupported display size dialog.</span></span><br><span class="line">                mUiHandler.sendEmptyMessage(SHOW_UNSUPPORTED_DISPLAY_SIZE_DIALOG_MSG);</span><br><span class="line"></span><br><span class="line">                killAllBackgroundProcessesExcept(Build.VERSION_CODES.N,</span><br><span class="line">                        ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.8】修改进程的配置信息！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=mLruProcesses.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="type">ProcessRecord</span> <span class="variable">app</span> <span class="operator">=</span> mLruProcesses.get(i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, <span class="string">&quot;Sending to proc &quot;</span></span><br><span class="line">                                + app.processName + <span class="string">&quot; new config &quot;</span> + mConfiguration);</span><br><span class="line">                        app.thread.scheduleConfigurationChanged(configCopy);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.9】发送配置改变的广播！</span></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_CONFIGURATION_CHANGED);</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_REPLACE_PENDING</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            broadcastIntentLocked(<span class="literal">null</span>, <span class="literal">null</span>, intent, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="literal">null</span>, <span class="literal">null</span>,</span><br><span class="line">                    <span class="literal">null</span>, AppOpsManager.OP_NONE, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">false</span>,</span><br><span class="line">                    MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">            <span class="keyword">if</span> ((changes&amp;ActivityInfo.CONFIG_LOCALE) != <span class="number">0</span>) &#123;</span><br><span class="line">                intent = <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_LOCALE_CHANGED);</span><br><span class="line">                intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">         <span class="keyword">if</span> (initLocale || !mProcessesReady) &#123;</span><br><span class="line">                    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">                &#125;</span><br><span class="line">                broadcastIntentLocked(<span class="literal">null</span>, <span class="literal">null</span>, intent,</span><br><span class="line">                        <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, AppOpsManager.OP_NONE,</span><br><span class="line">                        <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">false</span>, MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.10】更新 wms 中的配置信息，并且检查在更新了配置后，是否有 stack 需要被 resize；</span></span><br><span class="line">        <span class="comment">// 如果有的话，那就进行 resize 和 relaunch！</span></span><br><span class="line">        <span class="keyword">if</span> (mWindowManager != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span>[] resizedStacks = mWindowManager.setNewConfiguration(mConfiguration);</span><br><span class="line">            <span class="keyword">if</span> (resizedStacks != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> stackId : resizedStacks) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Rect</span> <span class="variable">newBounds</span> <span class="operator">=</span> mWindowManager.getBoundsForNewConfiguration(stackId);</span><br><span class="line">                    mStackSupervisor.resizeStackLocked(</span><br><span class="line">                            stackId, newBounds, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">false</span>, deferResume);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">kept</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityStack</span> <span class="variable">mainStack</span> <span class="operator">=</span> mStackSupervisor.getFocusedStack();</span><br><span class="line">    <span class="comment">//【4】获得焦点栈，调整 top activity 的配置信息！</span></span><br><span class="line">    <span class="comment">// mainStack is null during startup.</span></span><br><span class="line">    <span class="keyword">if</span> (mainStack != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (changes != <span class="number">0</span> &amp;&amp; starting == <span class="literal">null</span>) &#123;</span><br><span class="line">            starting = mainStack.topRunningActivityLocked();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (starting != <span class="literal">null</span>) &#123;</span><br><span class="line">            kept = mainStack.ensureActivityConfigurationLocked(starting, changes, <span class="literal">false</span>);</span><br><span class="line">            mStackSupervisor.ensureActivitiesVisibleLocked(starting, changes,</span><br><span class="line">                    !PRESERVE_WINDOWS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】继续布局！</span></span><br><span class="line">    <span class="keyword">if</span> (mWindowManager != <span class="literal">null</span>) &#123;</span><br><span class="line">        mWindowManager.continueSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> kept;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 UsageStatsService.reportConfigurationChange 方法，更新配置信息！</p>
<h3 id="2-2-3-LocalService-updateConfigurationLocked"><a href="#2-2-3-LocalService-updateConfigurationLocked" class="headerlink" title="2.2.3 LocalService.updateConfigurationLocked"></a>2.2.3 LocalService.updateConfigurationLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reportConfigurationChange</span><span class="params">(Configuration config, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;Configuration event reported with a null config&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.<span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsageEvents</span>.Event();</span><br><span class="line">    event.mPackage = <span class="string">&quot;android&quot;</span>;</span><br><span class="line"></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = UsageEvents.Event.CONFIGURATION_CHANGE;</span><br><span class="line">    event.mConfiguration = <span class="keyword">new</span> <span class="title class_">Configuration</span>(config);</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 config 相关的 event 来说，目标包名是 android！</p>
<h2 id="2-3-maybeUpdateProviderUsageStatsLocked"><a href="#2-3-maybeUpdateProviderUsageStatsLocked" class="headerlink" title="2.3 maybeUpdateProviderUsageStatsLocked"></a>2.3 maybeUpdateProviderUsageStatsLocked</h2><h3 id="2-3-1-调用时机"><a href="#2-3-1-调用时机" class="headerlink" title="2.3.1 调用时机"></a>2.3.1 调用时机</h3><ul>
<li><strong>ActivityManagerService.publishContentProviders</strong></li>
</ul>
<p>当注册 ContentProvider 的时候，会触发 publishContentProviders 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">publishContentProviders</span><span class="params">(IApplicationThread caller,</span></span><br><span class="line"><span class="params">        List&lt;ContentProviderHolder&gt; providers)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (providers == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">&quot;publishContentProviders&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ProcessRecord</span> <span class="variable">r</span> <span class="operator">=</span> getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">&quot;ProcessRecord uid = &quot;</span> + r.uid);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(</span><br><span class="line">                    <span class="string">&quot;Unable to find app for caller &quot;</span> + caller</span><br><span class="line">                  + <span class="string">&quot; (pid=&quot;</span> + Binder.getCallingPid()</span><br><span class="line">                  + <span class="string">&quot;) when publishing content providers&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> providers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="type">ContentProviderHolder</span> <span class="variable">src</span> <span class="operator">=</span> providers.get(i);</span><br><span class="line">                ... ... ...</span><br><span class="line">                updateOomAdjLocked(r);</span><br><span class="line">                <span class="comment">//【2.3.2】调用 maybeUpdateProviderUsageStatsLocked 方法，记录 ContentProvider 使用信息！</span></span><br><span class="line">                maybeUpdateProviderUsageStatsLocked(r, src.info.packageName,</span><br><span class="line">                        src.info.authority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerService.getContentProviderImpl</strong></li>
</ul>
<p>当获得 ContentProvider 的时候，会触发 getContentProviderImpl 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ContentProviderHolder <span class="title function_">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span><br><span class="line"><span class="params">        String name, IBinder token, <span class="type">boolean</span> stable, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    ContentProviderRecord cpr;</span><br><span class="line">    <span class="type">ContentProviderConnection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ProviderInfo</span> <span class="variable">cpi</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">        </span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">providerRunning</span> <span class="operator">=</span> cpr != <span class="literal">null</span> &amp;&amp; cpr.proc != <span class="literal">null</span> &amp;&amp; !cpr.proc.killed;</span><br><span class="line">        <span class="keyword">if</span> (providerRunning) &#123;</span><br><span class="line">            cpi = cpr.info;</span><br><span class="line">            String msg;</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;getContentProviderImpl: before checkContentProviderPermission&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ((msg = checkContentProviderPermissionLocked(cpi, r, userId, checkCrossUser))</span><br><span class="line">                    != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;getContentProviderImpl: after checkContentProviderPermission&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span> &amp;&amp; cpr.canRunHere(r)) &#123;</span><br><span class="line">                <span class="type">ContentProviderHolder</span> <span class="variable">holder</span> <span class="operator">=</span> cpr.newHolder(<span class="literal">null</span>);</span><br><span class="line">                holder.provider = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">return</span> holder;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">&quot;getContentProviderImpl: incProviderCountLocked&quot;</span>);</span><br><span class="line"></span><br><span class="line">            conn = incProviderCountLocked(r, cpr, token, stable);</span><br><span class="line">            <span class="keyword">if</span> (conn != <span class="literal">null</span> &amp;&amp; (conn.stableCount+conn.unstableCount) == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cpr.proc != <span class="literal">null</span> &amp;&amp; r.setAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                    checkTime(startTime, <span class="string">&quot;getContentProviderImpl: before updateLruProcess&quot;</span>);</span><br><span class="line">                    updateLruProcessLocked(cpr.proc, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">                    checkTime(startTime, <span class="string">&quot;getContentProviderImpl: after updateLruProcess&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">&quot;getContentProviderImpl: before updateOomAdj&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">verifiedAdj</span> <span class="operator">=</span> cpr.proc.verifiedAdj;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> updateOomAdjLocked(cpr.proc);</span><br><span class="line">            <span class="keyword">if</span> (success &amp;&amp; verifiedAdj != cpr.proc.setAdj &amp;&amp; !isProcessAliveLocked(cpr.proc)) &#123;</span><br><span class="line">                success = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.2.2】调用 maybeUpdateProviderUsageStatsLocked 方法再次记录！</span></span><br><span class="line">            maybeUpdateProviderUsageStatsLocked(r, cpr.info.packageName, name);</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;getContentProviderImpl: after updateOomAdj&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.i(TAG_PROVIDER, <span class="string">&quot;Adjust success: &quot;</span> + success);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">&quot;Existing provider &quot;</span> + cpr.name.flattenToShortString()</span><br><span class="line">                        + <span class="string">&quot; is crashing; detaching &quot;</span> + r);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">lastRef</span> <span class="operator">=</span> decProviderCountLocked(conn, cpr, token, stable);</span><br><span class="line">                checkTime(startTime, <span class="string">&quot;getContentProviderImpl: before appDied&quot;</span>);</span><br><span class="line">                appDiedLocked(cpr.proc);</span><br><span class="line">                checkTime(startTime, <span class="string">&quot;getContentProviderImpl: after appDied&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!lastRef) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                providerRunning = <span class="literal">false</span>;</span><br><span class="line">                conn = <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cpr.proc.verifiedAdj = cpr.proc.setAdj;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">        ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cpr != <span class="literal">null</span> ? cpr.newHolder(conn) : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>对于 getContentProviderImpl 这里我们不再过多分析！</p>
<h3 id="2-3-2-方法流程分析"><a href="#2-3-2-方法流程分析" class="headerlink" title="2.3.2 方法流程分析"></a>2.3.2 方法流程分析</h3><p>maybeUpdateProviderUsageStatsLocked 方法中会进行事件上报！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">maybeUpdateProviderUsageStatsLocked</span><span class="params">(ProcessRecord app, String providerPkgName,</span></span><br><span class="line"><span class="params">        String authority)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (app == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND) &#123;</span><br><span class="line">        <span class="type">UserState</span> <span class="variable">userState</span> <span class="operator">=</span> mUserController.getStartedUserStateLocked(app.userId);</span><br><span class="line">        <span class="keyword">if</span> (userState == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">lastReported</span> <span class="operator">=</span> userState.mProviderLastReportedFg.get(authority);</span><br><span class="line">        <span class="keyword">if</span> (lastReported == <span class="literal">null</span> || lastReported &lt; now - <span class="number">60</span> * <span class="number">1000L</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">                <span class="comment">//【2.3.3】调用了 reportContentProviderUsage 方法！</span></span><br><span class="line">                mUsageStatsService.reportContentProviderUsage(</span><br><span class="line">                        authority, providerPkgName, app.userId);</span><br><span class="line">            &#125;</span><br><span class="line">            userState.mProviderLastReportedFg.put(authority, now);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-3-LocalService-reportContentProviderUsage"><a href="#2-3-3-LocalService-reportContentProviderUsage" class="headerlink" title="2.3.3 LocalService.reportContentProviderUsage"></a>2.3.3 LocalService.reportContentProviderUsage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reportContentProviderUsage</span><span class="params">(String name, String packageName, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="type">SomeArgs</span> <span class="variable">args</span> <span class="operator">=</span> SomeArgs.obtain();</span><br><span class="line">    args.arg1 = name;</span><br><span class="line">    args.arg2 = packageName;</span><br><span class="line">    args.arg3 = userId;</span><br><span class="line">    <span class="comment">//【1】发送了 MSG_REPORT_CONTENT_PROVIDER_USAGE 消息！</span></span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_CONTENT_PROVIDER_USAGE, args)</span><br><span class="line">            .sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="2-4-maybeUpdateUsageStatsLocked"><a href="#2-4-maybeUpdateUsageStatsLocked" class="headerlink" title="2.4 maybeUpdateUsageStatsLocked"></a>2.4 maybeUpdateUsageStatsLocked</h2><h3 id="2-4-1-调用时机"><a href="#2-4-1-调用时机" class="headerlink" title="2.4.1 调用时机"></a>2.4.1 调用时机</h3><ul>
<li><strong>ActivityManagerService.applyOomAdjLocked</strong></li>
</ul>
<p>在调整进程的 oomAdj 的时候，会触发 maybeUpdateUsageStatsLocked！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">applyOomAdjLocked</span><span class="params">(ProcessRecord app, <span class="type">boolean</span> doingAll, <span class="type">long</span> now,</span></span><br><span class="line"><span class="params">        <span class="type">long</span> nowElapsed)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.curRawAdj != app.setRawAdj) &#123;</span><br><span class="line">        app.setRawAdj = app.curRawAdj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">changes</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.curAdj != app.setAdj) &#123;</span><br><span class="line">        ProcessList.setOomAdj(app.pid, app.info.uid, app.curAdj);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                <span class="string">&quot;Set &quot;</span> + app.pid + <span class="string">&quot; &quot;</span> + app.processName + <span class="string">&quot; adj &quot;</span> + app.curAdj + <span class="string">&quot;: &quot;</span></span><br><span class="line">                + app.adjType);</span><br><span class="line">        app.setAdj = app.curAdj;</span><br><span class="line">        app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】当进程的 ProcState 发生了变化是，进入 IF 分支！</span></span><br><span class="line">    <span class="keyword">if</span> (app.setProcState != app.curProcState) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                <span class="string">&quot;Proc state change of &quot;</span> + app.processName</span><br><span class="line">                        + <span class="string">&quot; to &quot;</span> + app.curProcState);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">setImportant</span> <span class="operator">=</span> app.setProcState &lt; ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">curImportant</span> <span class="operator">=</span> app.curProcState &lt; ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">        <span class="keyword">if</span> (setImportant &amp;&amp; !curImportant) &#123;</span><br><span class="line">            <span class="type">BatteryStatsImpl</span> <span class="variable">stats</span> <span class="operator">=</span> mBatteryStatsService.getActiveStatistics();</span><br><span class="line">            <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                app.lastWakeTime = stats.getProcessWakeTime(app.info.uid,</span><br><span class="line">                        app.pid, nowElapsed);</span><br><span class="line">            &#125;</span><br><span class="line">            app.lastCpuTime = app.curCpuTime;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4.1】在更新进程的状态之前，调用 maybeUpdateUsageStatsLocked 方法</span></span><br><span class="line">        <span class="comment">// 记录进程的信息！</span></span><br><span class="line">        maybeUpdateUsageStatsLocked(app, nowElapsed);</span><br><span class="line"></span><br><span class="line">        app.setProcState = app.curProcState;</span><br><span class="line">        <span class="keyword">if</span> (app.setProcState &gt;= ActivityManager.PROCESS_STATE_HOME) &#123;</span><br><span class="line">            app.notCachedSinceIdle = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!doingAll) &#123;</span><br><span class="line">            setProcessTrackerStateLocked(app, mProcessStats.getMemFactorLocked(), now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            app.procStateChanged = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.reportedInteraction &amp;&amp; (nowElapsed-app.interactionEventTime)</span><br><span class="line">            &gt; USAGE_STATS_INTERACTION_INTERVAL) &#123;</span><br><span class="line">        <span class="comment">//【2.4.1】对于长期处于互动状态的应用，我们需要每天至少报告一次，以免它们进入 idle 状态。</span></span><br><span class="line">        maybeUpdateUsageStatsLocked(app, nowElapsed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 maybeUpdateUsageStatsLocked 方法！</p>
<h3 id="2-4-2-方法流程分析"><a href="#2-4-2-方法流程分析" class="headerlink" title="2.4.2 方法流程分析"></a>2.4.2 方法流程分析</h3><p>下面我们来看看 maybeUpdateUsageStatsLocked 方法流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">maybeUpdateUsageStatsLocked</span><span class="params">(ProcessRecord app, <span class="type">long</span> nowElapsed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_USAGE_STATS) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">&quot;Checking proc [&quot;</span> + Arrays.toString(app.getPackageList())</span><br><span class="line">                + <span class="string">&quot;] state changes: old = &quot;</span> + app.setProcState + <span class="string">&quot;, new = &quot;</span></span><br><span class="line">                + app.curProcState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mUsageStatsService == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】判断此时进程是否处于交互中！        </span></span><br><span class="line">    <span class="type">boolean</span> isInteraction;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_BOUND_FOREGROUND_SERVICE) &#123;</span><br><span class="line">        <span class="comment">//【2】如果进程的 curProcState 小于等于 PROCESS_STATE_BOUND_FOREGROUND_SERVICE: 3</span></span><br><span class="line">        <span class="comment">// 此时是处于交互状态的！</span></span><br><span class="line">        isInteraction = <span class="literal">true</span>;</span><br><span class="line">        app.fgInteractionTime = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_TOP_SLEEPING) &#123;</span><br><span class="line">        <span class="comment">//【3】如果进程的 curProcState 小于等于 PROCESS_STATE_TOP_SLEEPING: 5</span></span><br><span class="line">        <span class="comment">// 进入这里！！</span></span><br><span class="line">        <span class="keyword">if</span> (app.fgInteractionTime == <span class="number">0</span>) &#123;</span><br><span class="line">            app.fgInteractionTime = nowElapsed;</span><br><span class="line">            isInteraction = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            isInteraction = nowElapsed &gt; app.fgInteractionTime + SERVICE_USAGE_INTERACTION_TIME;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】如果 app.forcingToForeground 为 null，并且进程的 curProcState </span></span><br><span class="line">        <span class="comment">// 小于等于 PROCESS_STATE_IMPORTANT_FOREGROUND:6 说明该进程是可以被感知的重要进程！</span></span><br><span class="line">        <span class="comment">// isInteraction 为 true！</span></span><br><span class="line">        isInteraction = app.forcingToForeground == <span class="literal">null</span></span><br><span class="line">                &amp;&amp; app.curProcState &lt;= ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</span><br><span class="line">        app.fgInteractionTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】如果本次进程是处于交互状态，并且上次是处于非交互状态（或者此时距离上次交互时间点超过了交互间隔）</span></span><br><span class="line">    <span class="comment">// 那么我们会上报一次记录！</span></span><br><span class="line">    <span class="keyword">if</span> (isInteraction &amp;&amp; (!app.reportedInteraction</span><br><span class="line">            || (nowElapsed-app.interactionEventTime) &gt; USAGE_STATS_INTERACTION_INTERVAL)) &#123;</span><br><span class="line">        app.interactionEventTime = nowElapsed;</span><br><span class="line">        String[] packages = app.getPackageList();</span><br><span class="line">        <span class="keyword">if</span> (packages != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; packages.length; i++) &#123;</span><br><span class="line">                <span class="comment">//【5.1】调用了 reportEvent 方法，更新进程中所有 pacakge 的使用信息</span></span><br><span class="line">                <span class="comment">// event 类型为 SYSTEM_INTERACTION！</span></span><br><span class="line">                mUsageStatsService.reportEvent(packages[i], app.userId,</span><br><span class="line">                        UsageEvents.Event.SYSTEM_INTERACTION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】更新 app.reportedInteraction 和 app.interactionEventTime！</span></span><br><span class="line">    app.reportedInteraction = isInteraction;</span><br><span class="line">    <span class="keyword">if</span> (!isInteraction) &#123;</span><br><span class="line">        app.interactionEventTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用了 UsageStatsService.reportEvent 方法！</p>
<h3 id="2-4-3-LocalService-reportEvent"><a href="#2-4-3-LocalService-reportEvent" class="headerlink" title="2.4.3 LocalService.reportEvent"></a>2.4.3 LocalService.reportEvent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reportEvent</span><span class="params">(String packageName, <span class="type">int</span> userId, <span class="type">int</span> eventType)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="literal">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;Event reported without a package name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.<span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsageEvents</span>.Event();</span><br><span class="line">    event.mPackage = packageName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This will later be converted to system time.</span></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = eventType;</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-shutdown"><a href="#2-5-shutdown" class="headerlink" title="2.5 shutdown"></a>2.5 shutdown</h2><p>shutdown 主要用关机时候，保存重要的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shutdown</span><span class="params">(<span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkCallingPermission(android.Manifest.permission.SHUTDOWN)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Requires permission &quot;</span></span><br><span class="line">                + android.Manifest.permission.SHUTDOWN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">timedout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        mShuttingDown = <span class="literal">true</span>;</span><br><span class="line">        updateEventDispatchingLocked();</span><br><span class="line">        timedout = mStackSupervisor.shutdownLocked(timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mAppOpsService.shutdown();</span><br><span class="line">    <span class="keyword">if</span> (mUsageStatsService != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】调用 UsageStatsService 的 prepareShutdown 方法！</span></span><br><span class="line">        mUsageStatsService.prepareShutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    mBatteryStatsService.shutdown();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        mProcessStats.shutdownLocked();</span><br><span class="line">        notifyTaskPersisterLocked(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> timedout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这个逻辑不多说了！</p>
<h1 id="3-NotificationManagerService"><a href="#3-NotificationManagerService" class="headerlink" title="3 NotificationManagerService"></a>3 NotificationManagerService</h1><p>我们来看看 NotificationManagerService 和 UsageStatsService 的通信：</p>
<h2 id="3-1-onStart"><a href="#3-1-onStart" class="headerlink" title="3.1 onStart"></a>3.1 onStart</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">Resources</span> <span class="variable">resources</span> <span class="operator">=</span> getContext().getResources();</span><br><span class="line"></span><br><span class="line">     mMaxPackageEnqueueRate = Settings.Global.getFloat(getContext().getContentResolver(),</span><br><span class="line">             Settings.Global.MAX_NOTIFICATION_ENQUEUE_RATE,</span><br><span class="line">             DEFAULT_MAX_NOTIFICATION_ENQUEUE_RATE);</span><br><span class="line">     ... ... ...</span><br><span class="line"></span><br><span class="line">     mAppUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br></pre></td></tr></table></figure>
<h2 id="3-2-setNotificationsShownFromListener"><a href="#3-2-setNotificationsShownFromListener" class="headerlink" title="3.2 setNotificationsShownFromListener"></a>3.2 setNotificationsShownFromListener</h2><p>当通知可见后 setNotificationsShownFromListener 会被触发！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNotificationsShownFromListener</span><span class="params">(INotificationListener token, String[] keys)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">identity</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mNotificationList) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ManagedServiceInfo</span> <span class="variable">info</span> <span class="operator">=</span> mListeners.checkServiceTokenLocked(token);</span><br><span class="line">            <span class="keyword">if</span> (keys != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> keys.length;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                    <span class="type">NotificationRecord</span> <span class="variable">r</span> <span class="operator">=</span> mNotificationsByKey.get(keys[i]);</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> r.sbn.getUserId();</span><br><span class="line">                    <span class="keyword">if</span> (userId != info.userid &amp;&amp; userId != UserHandle.USER_ALL &amp;&amp;</span><br><span class="line">                            !mUserProfiles.isCurrentProfile(userId)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Disallowed call from listener: &quot;</span></span><br><span class="line">                                + info.service);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!r.isSeen()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DBG) Slog.d(TAG, <span class="string">&quot;Marking notification as seen &quot;</span> + keys[i]);</span><br><span class="line">                        <span class="comment">//【1】调用了 UsageStatsService 的 reportEvent 方法！</span></span><br><span class="line">                        mAppUsageStats.reportEvent(r.sbn.getPackageName(),</span><br><span class="line">                                userId == UserHandle.USER_ALL ? UserHandle.USER_SYSTEM</span><br><span class="line">                                        : userId,</span><br><span class="line">                                UsageEvents.Event.USER_INTERACTION);</span><br><span class="line">                        r.setSeen();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对传入的 UserId 做了一个判断，如果为 UserHandle.USER_ALL，那么就设置为 UserHandle.USER_SYSTEM！</p>
<p>最终，调用了 UsageStatsService.reportEvent 上报事件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mAppUsageStats.reportEvent(r.sbn.getPackageName(),</span><br><span class="line">        userId == UserHandle.USER_ALL ? UserHandle.USER_SYSTEM</span><br><span class="line">                : userId,</span><br><span class="line">        UsageEvents.Event.USER_INTERACTION);</span><br></pre></td></tr></table></figure></p>
<h1 id="4-NetworkPolicyManagerService"><a href="#4-NetworkPolicyManagerService" class="headerlink" title="4 NetworkPolicyManagerService"></a>4 NetworkPolicyManagerService</h1><p>我们来看看 NetworkPolicyManagerService 和 UsageStatsService 的通信方式！</p>
<h2 id="4-1-systemReady"><a href="#4-1-systemReady" class="headerlink" title="4.1 systemReady"></a>4.1 systemReady</h2><p>先来看看 NetworkPolicyManagerService 的 systemReady 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">systemReady</span><span class="params">()</span> &#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_NETWORK, <span class="string">&quot;systemReady&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isBandwidthControlEnabled()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;bandwidth controls disabled, unable to enforce policy&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】获得了 UsageStats 对象！</span></span><br><span class="line">        mUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">        ... ... ... ...</span><br><span class="line">        <span class="comment">//【2】注册 AppIdleStateChangeListener 监听器！</span></span><br><span class="line">        mUsageStats.addAppIdleStateChangeListener(<span class="keyword">new</span> <span class="title class_">AppIdleStateChangeListener</span>());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_NETWORK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最关键的一个地方，就是监听器的注册！</p>
<h2 id="4-2-new-AppIdleStateChangeListener"><a href="#4-2-new-AppIdleStateChangeListener" class="headerlink" title="4.2 new AppIdleStateChangeListener"></a>4.2 new AppIdleStateChangeListener</h2><p>AppIdleStateChangeListener 继承了 UsageStatsManagerInternal.AppIdleStateChangeListener，覆写了两个父类方法：</p>
<ul>
<li><strong>onAppIdleStateChanged</strong>：用于监听 app idle 状态变化！</li>
</ul>
<ul>
<li><strong>onParoleStateChanged</strong>：用于监听 app 假释状态的变化！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">AppIdleStateChangeListener</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">UsageStatsManagerInternal</span>.AppIdleStateChangeListener &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="type">int</span> userId, <span class="type">boolean</span> idle)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> mContext.getPackageManager().getPackageUidAsUser(packageName,</span><br><span class="line">                    PackageManager.MATCH_UNINSTALLED_PACKAGES, userId);</span><br><span class="line">            <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">&quot;onAppIdleStateChanged(): uid=&quot;</span> + uid + <span class="string">&quot;, idle=&quot;</span> + idle);</span><br><span class="line">            <span class="keyword">synchronized</span> (mUidRulesFirstLock) &#123;</span><br><span class="line">                <span class="comment">//【4.3.1】更新 app idle 规则；</span></span><br><span class="line">                updateRuleForAppIdleUL(uid);</span><br><span class="line">                <span class="comment">//【4.3.2】更新省电模式的规则；</span></span><br><span class="line">                updateRulesForPowerRestrictionsUL(uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException nnfe) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onParoleStateChanged</span><span class="params">(<span class="type">boolean</span> isParoleOn)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mUidRulesFirstLock) &#123;</span><br><span class="line">            <span class="comment">//【4.4.1】更新 app idle parole 规则；</span></span><br><span class="line">            updateRulesForAppIdleParoleUL();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-App-Idle-State-Changed"><a href="#4-3-App-Idle-State-Changed" class="headerlink" title="4.3 App Idle State Changed"></a>4.3 App Idle State Changed</h2><p>处理 app idle 状态的改变！</p>
<p>当 AppIdleStateChangeListener.onAppIdleStateChanged 触发！</p>
<h3 id="4-3-1-updateRuleForAppIdleUL"><a href="#4-3-1-updateRuleForAppIdleUL" class="headerlink" title="4.3.1 updateRuleForAppIdleUL"></a>4.3.1 updateRuleForAppIdleUL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateRuleForAppIdleUL</span><span class="params">(<span class="type">int</span> uid)</span> &#123;</span><br><span class="line">    <span class="comment">//【1】判断 uid 是否在名单中，在名单中的应用不受机制影响！！</span></span><br><span class="line">    <span class="keyword">if</span> (!isUidValidForBlacklistRules(uid)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">appId</span> <span class="operator">=</span> UserHandle.getAppId(uid);</span><br><span class="line">    <span class="keyword">if</span> (!mPowerSaveTempWhitelistAppIds.get(appId) &amp;&amp; isUidIdle(uid)</span><br><span class="line">            &amp;&amp; !isUidForegroundOnRestrictPowerUL(uid)) &#123;</span><br><span class="line">        <span class="comment">//【4.3.1.1】修改 FIREWALL_CHAIN_STANDBY 的规则为 FIREWALL_RULE_DENY</span></span><br><span class="line">        setUidFirewallRule(FIREWALL_CHAIN_STANDBY, uid, FIREWALL_RULE_DENY);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4.3.1.2】修改 FIREWALL_CHAIN_STANDBY 的规则为 FIREWALL_RULE_DEFAULT</span></span><br><span class="line">        setUidFirewallRule(FIREWALL_CHAIN_STANDBY, uid, FIREWALL_RULE_DEFAULT);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-1-1-setUidFirewallRule"><a href="#4-3-1-1-setUidFirewallRule" class="headerlink" title="4.3.1.1 setUidFirewallRule"></a>4.3.1.1 setUidFirewallRule</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setUidFirewallRule</span><span class="params">(<span class="type">int</span> chain, <span class="type">int</span> uid, <span class="type">int</span> rule)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (chain == FIREWALL_CHAIN_DOZABLE) &#123;</span><br><span class="line">        mUidFirewallDozableRules.put(uid, rule);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chain == FIREWALL_CHAIN_STANDBY) &#123;</span><br><span class="line">        <span class="comment">//【1】将 FIREWALL_CHAIN_STANDBY 相关的规则加入 mUidFirewallStandbyRules！</span></span><br><span class="line">        mUidFirewallStandbyRules.put(uid, rule);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chain == FIREWALL_CHAIN_POWERSAVE) &#123;</span><br><span class="line">        mUidFirewallPowerSaveRules.put(uid, rule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mNetworkManager.setFirewallUidRule(chain, uid, rule);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">        Log.wtf(TAG, <span class="string">&quot;problem setting firewall uid rules&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// ignored; service lives in system_server</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-2-updateRulesForPowerRestrictionsUL-1"><a href="#4-3-2-updateRulesForPowerRestrictionsUL-1" class="headerlink" title="4.3.2 updateRulesForPowerRestrictionsUL[1]"></a>4.3.2 updateRulesForPowerRestrictionsUL[1]</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateRulesForPowerRestrictionsUL</span><span class="params">(<span class="type">int</span> uid)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">oldUidRules</span> <span class="operator">=</span> mUidRules.get(uid, RULE_NONE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newUidRules</span> <span class="operator">=</span> updateRulesForPowerRestrictionsUL(uid, oldUidRules, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newUidRules == RULE_NONE) &#123;</span><br><span class="line">        mUidRules.delete(uid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mUidRules.put(uid, newUidRules);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-Parole-State-Changed"><a href="#4-4-Parole-State-Changed" class="headerlink" title="4.4 Parole State Changed"></a>4.4 Parole State Changed</h2><p>处理 app 假释状态的改变！</p>
<h3 id="4-4-1-updateRulesForAppIdleParoleUL"><a href="#4-4-1-updateRulesForAppIdleParoleUL" class="headerlink" title="4.4.1 updateRulesForAppIdleParoleUL"></a>4.4.1 updateRulesForAppIdleParoleUL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateRulesForAppIdleParoleUL</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//【1】判断此时是否处于假释状态！</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">paroled</span> <span class="operator">=</span> mUsageStats.isAppIdleParoleOn();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】判断是否可以访问网网络！</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">enableChain</span> <span class="operator">=</span> !paroled;</span><br><span class="line">    enableFirewallChainUL(FIREWALL_CHAIN_STANDBY, enableChain);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】遍历 mUidFirewallStandbyRules 中的所有 rule！</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ruleCount</span> <span class="operator">=</span> mUidFirewallStandbyRules.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ruleCount; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> mUidFirewallStandbyRules.keyAt(i);</span><br><span class="line">        <span class="type">int</span> <span class="variable">oldRules</span> <span class="operator">=</span> mUidRules.get(uid);</span><br><span class="line">        <span class="keyword">if</span> (enableChain) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果可以访问网络，取消掉 RULE_ALLOW_ALL/RULE_REJECT_ALL 位！</span></span><br><span class="line">            oldRules &amp;= MASK_METERED_NETWORKS;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】如果不可以访问网络，并且 oldRules 没有设置 RULE_ALLOW_ALL/RULE_REJECT_ALL 位！</span></span><br><span class="line">            <span class="comment">// 那就跳过，否则进入下面的环节！</span></span><br><span class="line">            <span class="keyword">if</span> ((oldRules &amp; MASK_ALL_NETWORKS) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4.4.2】进入 updateRulesForPowerRestrictionsUL 方法！</span></span><br><span class="line">        updateRulesForPowerRestrictionsUL(uid, oldRules, paroled);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-2-updateRulesForPowerRestrictionsUL-3"><a href="#4-4-2-updateRulesForPowerRestrictionsUL-3" class="headerlink" title="4.4.2 updateRulesForPowerRestrictionsUL[3]"></a>4.4.2 updateRulesForPowerRestrictionsUL[3]</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">updateRulesForPowerRestrictionsUL</span><span class="params">(<span class="type">int</span> uid, <span class="type">int</span> oldUidRules, <span class="type">boolean</span> paroled)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isUidValidForBlacklistRules(uid)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOGD) Slog.d(TAG, <span class="string">&quot;no need to update restrict power rules for uid &quot;</span> + uid);</span><br><span class="line">        <span class="keyword">return</span> RULE_NONE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】判断是否是 idle 状态！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isIdle</span> <span class="operator">=</span> !paroled &amp;&amp; isUidIdle(uid);</span><br><span class="line">    <span class="comment">//【2】判断是否是强制模式！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">restrictMode</span> <span class="operator">=</span> isIdle || mRestrictPower || mDeviceIdleMode;</span><br><span class="line">    <span class="comment">//【3】判断 uid 下的进程是否是前台进程！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isForeground</span> <span class="operator">=</span> isUidForegroundOnRestrictPowerUL(uid);</span><br><span class="line">    <span class="comment">//【4】判断 uid 是否在省电白名单中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isWhitelisted</span> <span class="operator">=</span> isWhitelistedBatterySaverUL(uid);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">oldRule</span> <span class="operator">=</span> oldUidRules &amp; MASK_ALL_NETWORKS;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newRule</span> <span class="operator">=</span> RULE_NONE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】</span></span><br><span class="line">    <span class="keyword">if</span> (isForeground) &#123;</span><br><span class="line">        <span class="keyword">if</span> (restrictMode) &#123;</span><br><span class="line">            newRule = RULE_ALLOW_ALL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (restrictMode) &#123;</span><br><span class="line">        newRule = isWhitelisted ? RULE_ALLOW_ALL : RULE_REJECT_ALL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】计算新的 rules,oldUidRules &amp; MASK_METERED_NETWORKS 取消旧的高四位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newUidRules</span> <span class="operator">=</span> (oldUidRules &amp; MASK_METERED_NETWORKS) | newRule;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (LOGV) &#123;</span><br><span class="line">        Log.v(TAG, <span class="string">&quot;updateRulesForPowerRestrictionsUL(&quot;</span> + uid + <span class="string">&quot;)&quot;</span></span><br><span class="line">                + <span class="string">&quot;, isIdle: &quot;</span> + isIdle</span><br><span class="line">                + <span class="string">&quot;, mRestrictPower: &quot;</span> + mRestrictPower</span><br><span class="line">                + <span class="string">&quot;, mDeviceIdleMode: &quot;</span> + mDeviceIdleMode</span><br><span class="line">                + <span class="string">&quot;, isForeground=&quot;</span> + isForeground</span><br><span class="line">                + <span class="string">&quot;, isWhitelisted=&quot;</span> + isWhitelisted</span><br><span class="line">                + <span class="string">&quot;, oldRule=&quot;</span> + uidRulesToString(oldRule)</span><br><span class="line">                + <span class="string">&quot;, newRule=&quot;</span> + uidRulesToString(newRule)</span><br><span class="line">                + <span class="string">&quot;, newUidRules=&quot;</span> + uidRulesToString(newUidRules)</span><br><span class="line">                + <span class="string">&quot;, oldUidRules=&quot;</span> + uidRulesToString(oldUidRules));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】如果规则发生了变化，那就发送 MSG_RULES_CHANGED 消息！</span></span><br><span class="line">    <span class="keyword">if</span> (newRule != oldRule) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newRule == RULE_NONE || (newRule &amp; RULE_ALLOW_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">&quot;Allowing non-metered access for UID &quot;</span> + uid);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((newRule &amp; RULE_REJECT_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">&quot;Rejecting non-metered access for UID &quot;</span> + uid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.wtf(TAG, <span class="string">&quot;Unexpected change of non-metered UID state for &quot;</span> + uid</span><br><span class="line">                    + <span class="string">&quot;: foreground=&quot;</span> + isForeground</span><br><span class="line">                    + <span class="string">&quot;, whitelisted=&quot;</span> + isWhitelisted</span><br><span class="line">                    + <span class="string">&quot;, newRule=&quot;</span> + uidRulesToString(newUidRules)</span><br><span class="line">                    + <span class="string">&quot;, oldRule=&quot;</span> + uidRulesToString(oldUidRules));</span><br><span class="line">        &#125;</span><br><span class="line">        mHandler.obtainMessage(MSG_RULES_CHANGED, uid, newUidRules).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newUidRules;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="5-AppIdleController"><a href="#5-AppIdleController" class="headerlink" title="5 AppIdleController"></a>5 AppIdleController</h1><p>学习过 JobSchedulerSerivce，我们知道 AppIdleController 会判断 app 是否进入 idle 状态，这样动态控制 app 对应的 job！</p>
<h2 id="5-1-new-AppIdleController"><a href="#5-1-new-AppIdleController" class="headerlink" title="5.1 new AppIdleController"></a>5.1 new AppIdleController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    <span class="comment">//【1】获得 UsageStatsService 的 LocalService 对象！</span></span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    <span class="comment">//【2】初始化 mAppIdleParoleOn 为 true！</span></span><br><span class="line">    mAppIdleParoleOn = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//【3】注册 AppIdleStateChangeListener 监听器！</span></span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> <span class="title class_">AppIdleStateChangeListener</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-new-AppIdleStateChangeListener"><a href="#5-2-new-AppIdleStateChangeListener" class="headerlink" title="5.2 new AppIdleStateChangeListener"></a>5.2 new AppIdleStateChangeListener</h2><p>AppIdleStateChangeListener 用于监听 app idle 状态的变化！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">AppIdleStateChangeListener</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">UsageStatsManagerInternal</span>.AppIdleStateChangeListener &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="type">int</span> userId, <span class="type">boolean</span> idle)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//【1】如果此时应用进入了假释状态，不处理！</span></span><br><span class="line">            <span class="keyword">if</span> (mAppIdleParoleOn) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】为系统中的所有 Job 执行 PackageUpdateFunc 操作！</span></span><br><span class="line">            <span class="comment">// idle 表示是否处于 idle 状态！</span></span><br><span class="line">            <span class="type">PackageUpdateFunc</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageUpdateFunc</span>(userId, packageName, idle);</span><br><span class="line">            mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">            <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">                changed = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】通知 JobSchedulerService，AppIdleController 状态发生了变化！</span></span><br><span class="line">        <span class="comment">// 需要执行/停止 Job！</span></span><br><span class="line">        <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onParoleStateChanged</span><span class="params">(<span class="type">boolean</span> isParoleOn)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">&quot;Parole on: &quot;</span> + isParoleOn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】当应用的假释模式发生变化后，调用 setAppIdleParoleOn 方法！</span></span><br><span class="line">        setAppIdleParoleOn(isParoleOn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>当应用的 app idle 状态发生了变化，会触发 onAppIdleStateChanged 方法！</li>
<li>当应用的 app 假释状态发生了变化，会触发 onParoleStateChanged 方法！</li>
</ul>
<h3 id="5-2-1-PackageUpdateFunc-process"><a href="#5-2-1-PackageUpdateFunc-process" class="headerlink" title="5.2.1 PackageUpdateFunc.process"></a>5.2.1 PackageUpdateFunc.process</h3><p>当 app idle 状态变化后，会触发 AppIdleController.AppIdleStateChangeListener.onAppIdleStateChanged 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PackageUpdateFunc</span> <span class="keyword">implements</span> <span class="title class_">JobStore</span>.JobStatusFunctor &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> mUserId;</span><br><span class="line">    <span class="keyword">final</span> String mPackage;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> mIdle;</span><br><span class="line">    <span class="type">boolean</span> mChanged; <span class="comment">// 是否有 job 的条件发生变化！</span></span><br><span class="line"></span><br><span class="line">    PackageUpdateFunc(<span class="type">int</span> userId, String pkg, <span class="type">boolean</span> idle) &#123;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">        mPackage = pkg;</span><br><span class="line">        mIdle = idle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(JobStatus jobStatus)</span> &#123;</span><br><span class="line">        <span class="comment">//【1】匹配到对应的 JobStatus！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.getSourcePackageName().equals(mPackage)</span><br><span class="line">                &amp;&amp; jobStatus.getSourceUserId() == mUserId) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1】设置 Job 的 AppNotIdle 条件，如果 Job 的条件发生变化</span></span><br><span class="line">            <span class="comment">// mChanged 为 true！</span></span><br><span class="line">            <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!mIdle)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(LOG_TAG, <span class="string">&quot;App Idle state changed, setting idle state of &quot;</span></span><br><span class="line">                            + mPackage + <span class="string">&quot; to &quot;</span> + mIdle);</span><br><span class="line">                &#125;</span><br><span class="line">                mChanged = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>jobStatus.setAppNotIdleConstraintSatisfied 方法用于设置 app 是否满足不处于 idle 状态下的条件！</p>
<h3 id="5-2-2-setAppIdleParoleOn"><a href="#5-2-2-setAppIdleParoleOn" class="headerlink" title="5.2.2 setAppIdleParoleOn"></a>5.2.2 setAppIdleParoleOn</h3><p>当应用的 app 假释状态发生了变化，会触发 setAppIdleParoleOn 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">setAppIdleParoleOn</span><span class="params">(<span class="type">boolean</span> isAppIdleParoleOn)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】如果假释状态没有变化，不处理!</span></span><br><span class="line">        <span class="keyword">if</span> (mAppIdleParoleOn == isAppIdleParoleOn) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】保存最新的假释状态！</span></span><br><span class="line">        mAppIdleParoleOn = isAppIdleParoleOn;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】对所有的 Job 执行 GlobalUpdateFunc！</span></span><br><span class="line">        <span class="type">GlobalUpdateFunc</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GlobalUpdateFunc</span>();</span><br><span class="line">        mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】如果 Job 触发条件变化，changed 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">            changed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】通知 JobSchedulerService，AppIdleController 状态发生了变化！</span></span><br><span class="line">    <span class="comment">// 需要执行/停止 Job！</span></span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法流程很简单！</p>
<h4 id="5-2-2-1-GlobalUpdateFunc-process"><a href="#5-2-2-1-GlobalUpdateFunc-process" class="headerlink" title="5.2.2.1 GlobalUpdateFunc.process"></a>5.2.2.1 GlobalUpdateFunc.process</h4><p>我们来看看 GlobalUpdateFunc 的逻辑！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">GlobalUpdateFunc</span> <span class="keyword">implements</span> <span class="title class_">JobStore</span>.JobStatusFunctor &#123;</span><br><span class="line">    <span class="type">boolean</span> mChanged;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(JobStatus jobStatus)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> jobStatus.getSourcePackageName();</span><br><span class="line">        <span class="comment">//【1】判断 app 是否处于 idle 状态，满足条件是进入了 idle 状态，但是不能是假释状态！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">appIdle</span> <span class="operator">=</span> !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">                jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">&quot;Setting idle state of &quot;</span> + packageName + <span class="string">&quot; to &quot;</span> + appIdle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】修改 Job 的 appNotIdle 执行条件，如果条件发生了变化，mChanged 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!appIdle)) &#123;</span><br><span class="line">            mChanged = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>方法流程很简单！</p>
<h2 id="5-3-maybeStartTrackingJobLocked"><a href="#5-3-maybeStartTrackingJobLocked" class="headerlink" title="5.3 maybeStartTrackingJobLocked"></a>5.3 maybeStartTrackingJobLocked</h2><p>AppIdleController 开始监控指定的 Job！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">maybeStartTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span> &#123;</span><br><span class="line">    <span class="comment">//【1】如果还没有初始化过假释状态，进行初始化！</span></span><br><span class="line">    <span class="keyword">if</span> (!mInitializedParoleOn) &#123;</span><br><span class="line">        mInitializedParoleOn = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//【1.1】调用 UsageStatsService.isAppIdleParoleOn 方法判断此时是否是应用假释模式！</span></span><br><span class="line">        mAppIdleParoleOn = mUsageStatsInternal.isAppIdleParoleOn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> jobStatus.getSourcePackageName();</span><br><span class="line">    <span class="comment">//【2】判断 app 是否处于 app idle ，满足 2 个条件，应用处于 idle 状态，但是不能处于假释模式！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">appIdle</span> <span class="operator">=</span> !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">            jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(LOG_TAG, <span class="string">&quot;Start tracking, setting idle state of &quot;</span></span><br><span class="line">                + packageName + <span class="string">&quot; to &quot;</span> + appIdle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】设置 Job 的条件属性！</span></span><br><span class="line">    jobStatus.setAppNotIdleConstraintSatisfied(!appIdle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法流程很简单！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Li Shuaiqi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2017/08/03/UsageStats4-usageStatsServiceInteractionWithServiceOrProcess/">https://lishuaiqi.top/2017/08/03/UsageStats4-usageStatsServiceInteractionWithServiceOrProcess/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Li Shuaiqi's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/UsageStats%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/">UsageStats使用状态管理</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/08/13/Permission4-requestPermission/"><i class="fa fa-chevron-left">  </i><span>Permission第 4 篇 - requestPermission 权限申请</span></a></div><div class="next-post pull-right"><a href="/2017/08/01/AppOps1-AppOpsServiceStartProcess/"><span>AppOps 第 1 篇 - AppOpsService 的启动</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2025 By Li Shuaiqi</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>